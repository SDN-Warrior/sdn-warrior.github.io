

<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="robots" content="index, follow"><link rel="author" href="/humans.txt">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" href="/favicon.ico" type="image/x-icon"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">
<meta name="theme-color" content="#494f5c">
<meta name="msapplication-TileColor" content="#494f5c">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#494f5c"><meta name="author" content="SDN-Warrior"><meta name="description" content="Live Migration of Workloads with VMware HCX: A Customer Story">

  <meta itemprop="name" content="Migration with HCX">
  <meta itemprop="description" content="Live Migration of Workloads with VMware HCX: A Customer Story">
  <meta itemprop="datePublished" content="2025-01-28T20:00:00+01:00">
  <meta itemprop="dateModified" content="2025-01-28T20:00:00+01:00">
  <meta itemprop="wordCount" content="2450">
  <meta itemprop="image" content="https://sdn-warrior.org/images/logo.jpg">
  <meta itemprop="keywords" content="Vcf,Hcx,Vmware"><meta property="og:url" content="https://sdn-warrior.org/posts/migration-with-hcx/">
  <meta property="og:site_name" content="SDN-Warrior | Daniel Krieger">
  <meta property="og:title" content="Migration with HCX">
  <meta property="og:description" content="Live Migration of Workloads with VMware HCX: A Customer Story">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-01-28T20:00:00+01:00">
    <meta property="article:modified_time" content="2025-01-28T20:00:00+01:00">
    <meta property="article:tag" content="Vcf">
    <meta property="article:tag" content="Hcx">
    <meta property="article:tag" content="Vmware">
    <meta property="og:image" content="https://sdn-warrior.org/images/logo.jpg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://sdn-warrior.org/images/logo.jpg">
  <meta name="twitter:title" content="Migration with HCX">
  <meta name="twitter:description" content="Live Migration of Workloads with VMware HCX: A Customer Story">

<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Migration with HCX",
    "name": "Migration with HCX",
    "description": "Live Migration of Workloads with VMware HCX: A Customer Story",
    "keywords": ["vcf", "hcx", "vmware"],
    "articleBody": "Introduction I was brought in to help with a customer project that involved a VCF setup and migrating the workload domains to a new VCF deployment. The challenge of this project was that we had to adopt the existing networks without making any changes while also reducing the downtime of the workloads to an absolute minimum. We used HCX and network extension to solve this problem.\nWhat is HCX? VMware HCX is an application mobility platform designed to simplify application migration, workload redeployment, and disaster recovery in data centers and clouds.\nHCX covers several use cases:\nPlan and install HCX, and the Multi-Site Service Mesh Build the initial secure pipeline between two connected VMware HCX sites, including connections between associated HCX services.\nExtend Networks with HCX Seamlessly extend vSphere and NSX network segments and retain the IP and MAC addresses of migrated VMs to accelerate consumption of modernized resources. Network Extension minimizes the need for complicated networking changes.\nMigrating Virtual Machines Select from multiple HCX mobility technologies for optimized migrations at scale for both VMware and non-VMware workloads.\nVirtual Machine Disaster Recovery Protect data center applications and workloads through asynchronous replication and recovery of virtual machines, as well as integration with the VMware’s Site Recovery Manager suite of features and tools.\nIn short, HCX is the answer to my customer problem.\nFirst things first: what are the requirements for HCX? Since HCX has been part of VCF since version 5.1.1, many customers have the opportunity to benefit from HCX. For those who want to test VCF, here is the good news: an eval license comes with HCX. Eval License\rThe eval license has a runtime of 60 days and can migrate a maximum of 20 VMs per migration type.\rFor environments requiring NSX virtual networking, you must install and configure NSX, including integration with the vCenter Server, before deploying HCX Manager.\nIn the destination environment, the NSX Manager must be installed and integrated with the vCenter Server.\nThe NSX Manager must be registered during the HCX Manager install with the admin user.\nIf the NSX Manager IP or FQDN uses self-signed certificates, it might be necessary to trust the NSX system manually using the Import Cert by URL interface in the HCX Appliance Management interface.\nHCX requires an NSX configured with an Overlay Transport Zone.\nWhen NSX-T is registered, both Overlay and VLAN segments can be used during the Network Profile creation.\nIn NSX-T deployments, the HCX supports integration with networking objects created with the NSX Simplified UI/API only.\nCompute Ressources Appliance vCPU Memory Disk Space/IOPS HCX Manager 4 12 GB 60 GB HCX Interconnect (HCX-IX) 8 6 GB 2 GB HCX Network Extension (HCX-NE) 8 3 GB 2 GB Network Ressources I need one HCX appliance per workload domain. This needs access to the respective vCenter and the associated NSX manager. In addition, the HCX appliance must be placed in the vMotion network of the respective workload domain. This can be done by routing or the HCX appliance can be given an IP address directly in the vMotion network. I also need at least one uplink VLAN for the HCX appliances to communicate via. This could be done via WAN, for example. For my customer, this is a VLAN in the underlay network.\nInfo\rOf course, I can’t cover all the migration scenarios that are possible with HCX in this article, which is why the requirements also vary. For my scenario at my customer’s site, we decided on vMotion migration between the two VCF stacks. In addition, the Network Extension is to be used to minimize downtime.\rDeploying and configuring HCX appliance After deploying the HCX appliance, it must be initially configured. To do this, you have to log in to the management interface via (https://hcx-ip-or-fqdn:9443) using the configured admin credentials. The HCX appliance must have access to the NSX manager, the vCenter must be configured, the public access URL (in my case only internally resolvable) and the SSO domain (vCenter). After successful configuration, you can log in to the HCX appliance with the vCenter credentials. The local admin account only works on the HCX management interface.\nHCX settings (click to enlarge)\nGet started with HCX HCX requires the following: at least one network profile, one compute profile, one or more service mesh and one or more site pairs.\nSite Pair A Site Pair establishes the connection needed for management, authentication, and orchestration of HCX services across a source and destination environment. To create a new site pair, we need the remote HCX URL, which was configured when deploying the HCX appliance. This must be resolvable via the management network. You also need a vCenter user in the target environment who has sufficient permissions. In my lab I use the vsphere.local administrator. This is of course not best practice and should be adapted in a productive environment.\nHCX Site Pair (click to enlarge)\nNetwork profiles After the Site Pair, I set up the network profiles for the interconnect. These profiles allow me to determine the IP addresses and networks. Depending on the setup and service, you need different networks here. In my customer scenario, I can manage with two networks. One profile for management traffic, which I use to access the vCenter and the NSX Manager from environment A. The second network is for the actual uplink connection. In my lab I have 2 uplink networks for testing, so the screenshots may differ slightly. I select the appropriate distributed port group and assign a free IP range. You can define the HCX traffic type, but this is only used as a suggestion in the compute profile. Just because I mark a network profile as an HCX uplink doesn’t mean it has to be used as an uplink. It only serves to mark the networks for easier configuration in the compute profile. The vMotion network is routed in my lab. If this is not possible, you can also configure direct access to the vMotion network for the HCX appliance via the network profiles. This is necessary if the vMotion network cannot be routed.\nHCX network profiles settings (click to enlarge)\nFree Ip Adresses\rNote: I need one free IP in the MGMT network for each of the following: Pro Network Extension, HCX Appliane and Servicemesh (3 IPs). In the vMotion network, 1 IP is required per service mesh (if the vMotion network is not routed) and at least 1 uplink IP is required per service mesh. The HCX interface offers a calculator for the calculation.\rCompute Profiles The compute profiles in HCX are used to specify which HCX services, compute resources such as clusters or resource pools or networks are connected. You can also set CPU and memory reservations for the interconnect appliance. Depending on the HCX service, you have to assign several networks, e.g. management network, uplink networks, vMotion network and the network container. In my case, the network container is the overlay transport zone from my source NSX, as I want to migrate machines from one NSX environment to another NSX environment.\nHCX Compute profiles settings (click to enlarge)\nThe screenshot shows very clearly how the Interconnect appliance is later connected. The uplinks can be VLAN connections within a data center, public WAN connections, MPLS or VPN. There are very few restrictions here. The uplink networks only need to reach each other between the locations. It does not matter whether it is via Layer2 or Layer3.\nService Mesh In the service mesh, compute profiles, HCX services and advanced configurations such as MTU for uplink links or the number of appliances for the network extension are defined and assigned. After I have configured the service mesh, the interconnect VMs are automatically deployed at both HCX locations.\nHCX Service Mesh (click to enlarge)\nService Mesh\rThe service mesh cannot be created until both sides of the site pair are configured and have compute and network profiles.\rFirewall Settings for HCX After successfully setting up the interconnect compute profile, a firewall port matrix is created that you can easy copy and export over the HCX gui. Here is an example from my lab.\nSource Destination Services ANY ANY UDP(3784) 192.168.70.30-192.168.70.40 192.168.70.30-192.168.70.40 UDP(3784), TCP(8182) 192.168.70.30-192.168.70.40 192.168.70.10 TCP(9555) 192.168.70.30-192.168.70.40 192.168.12.100 TCP(443) 192.168.70.10 192.168.70.30-192.168.70.40 TCP(9443) 192.168.70.10 192.168.12.100 TCP(443) 192.168.70.10 192.168.12.203, 192.168.12.204 TCP(902), TCP(80), TCP(443) 192.168.12.203, 192.168.12.204 192.168.70.30-192.168.70.40 TCP(31031), TCP(32032), TCP(44046) 192.168.70.30-192.168.70.40 192.168.12.203, 192.168.12.204 TCP(902), TCP(80) 192.168.12.203, 192.168.12.204 192.168.70.30-192.168.70.40 TCP(8000) 192.168.70.30-192.168.70.40 192.168.12.203, 192.168.12.204 TCP(8000) 192.168.70.10 192.168.70.30-192.168.70.40 TCP(443), TCP(8123), TCP(9443) ANY 172.21.22.10-172.21.22.100, 172.21.21.10-172.21.21.100 TCP(5201), UDP(4500), UDP(5201) Network Extension With the network extension in HCX, layer-2 networks can be extended between the source and target environments without having to change the IP addressing of the workloads. This allows virtual machines to be seamlessly migrated while maintaining their existing network connection and connectivity, and is a prerequisite for a “zero” downtime migration. To create a layer 2 stretch via the network extension, I just have to click on Network Extension » Create a Network Extension and select my network that I want to stretch to the other location via HCX. Here I can only choose from networks in my previously configured network container. In my case, these are the networks from my NSX.\nHCX Network Extension (click to enlarge)\nThe stretched networks are created at the selected T1 router in the target environment and given a prefix. However, the segments are not connected to the T1. The north/south connection is via the T1 and T0 in the source environment. This ensures that no traffic for the VMs is routed into a black hole.\nAttention\rFor each network that is stretched across the network extension, a network adapter is required on the appliance. Since the appliance is subject to the same limits as all other VMs, a maximum of 10 network adapters can be used. In my case, I lose 1 adapter for management and two adapters for my uplinks. So I can stretch a maximum of 7 NSX networks over this appliance. If I want to stretch more networks, I need another network extension appliance.\rHow does Network Extension work? The sink port on the HCX Network Extension serves as the endpoint for the extended Layer 2 traffic between the source and target environments. It is configured on the source and target sides to receive and send the incoming traffic from the extended network. This can be easily seen on the segment ports in the NSX of the HCX appliance. This is where MAC/IP bindings are exchanged between VMs. If you look at the destination side, you will see (provided that the source VMs are generating traffic) the IP/MAC bindings of the VMs on the source segment on the sink port and vice versa for VMs that have already been migrated to the destination side.\nHCX Network Extension Bindings (click to enlarge)\nFor this to work, special port profiles are created for the segment ports of the HCX Network Extension appliance that allow MAC learning, MAC changing and unknown unicast flooding. By default, the NSX segment profile would prevent this and block it.\nMigrating VMs HCX supports a wide range of migration options. Since I aim for zero downtime, I use vMotion as my migration method. For less critical VMs with a maintenance window, a bulk migration with short downtime is also an option. Here you can plan a mass migration and make a controlled switchover at a certain point in time. To do this, a replica of the VMs is created and incrementally synchronized. During the cutover, the final delta data is synchronized and the VM is switched on again. After the migration, the VM is switched on again at the destination. Of course, there are several variants and not every variant is suitable.\nvMotion migration in VMware HCX allows me to migrate virtual machines live and without downtime from a source environment to a target environment. HCX uses the vMotion technology but extends it to include the option of migrating workloads in a scheduled manner and across geographically separate data centers.\nTo plan the migration, I go to Services » Migration and create a NEW Mobility Group. Here I can set all the relevant migration settings.\nHCX New Mobility Group (click to enlarge)\nThe settings are relatively self-explanatory. I select my VMs, choose the target cluster, storage and switchover time, and select my migration method. If the VM comes from a network stretched with the Network Extension, the target network is already preselected. I just have to perform the validation and the migration can start. It is also possible to perform a reverse migration.\nHCX New Mobility Group (click to enlarge)\nThe migration was successful and there was only one ping interruption during the entire migration. The VM was functional and accessible the whole time. Thanks to the network extension, both east/west and north/south traffic works.\n64 bytes from 10.10.20.20: icmp_seq=34 ttl=60 time=6.854 ms\r64 bytes from 10.10.20.20: icmp_seq=35 ttl=60 time=2.144 ms\rRequest timeout for icmp_seq 36\r64 bytes from 10.10.20.20: icmp_seq=37 ttl=60 time=11.416 ms\r64 bytes from 10.10.20.20: icmp_seq=38 ttl=60 time=4.916 ms\r64 bytes from 10.10.20.20: icmp_seq=39 ttl=60 time=3.661 ms\r64 bytes from 10.10.20.20: icmp_seq=40 ttl=60 time=3.842 ms\r--- 10.10.20.20 ping statistics ---\r57 packets transmitted, 56 packets received, 1.8% packet loss After all VMs have been migrated from the source to the target, the network extension for the network via HCX can be removed. If desired, HCX can automatically connect the segments at the target to the T1 router. The segments at the source must then be manually disconnected from the source T1. As long as the same segment subnet is connected to the source and target at the local T1, routing problems may occur. This can be successfully prevented with local preference and AS-Path prepend, by making the segments on the source side less favorable if BGP is used. This only affects north/south connectivity. East/west connectivity is not affected.\nConclusion I am aware that I have not even touched on all the functions of HCX. The tool is extremely powerful and you always have to look at the scenario for which you are using the right HCX use case. So I have not addressed the WAN optimization or the MON feature, nor have I gone into detail about the other migration options. The whole thing would go beyond the scope by far and I wanted to write about a scenario that I have already implemented for a customer. I can advise everyone to take a closer look at HCX. With HCX, you have a powerful migration tool that can help you out of unpleasant situations or simply simplifies mass migrations from A to B. Since HCX is now part of the VCF product portfolio, there is no reason not to use the tool.\n",
    "wordCount" : "2450",
    "inLanguage": "en",
    "image":"https://sdn-warrior.org/images/net.jpg","datePublished": "2025-01-28T20:00:00+01:00",
    "dateModified": "2025-01-28T20:00:00+01:00",
    "author":{
        "@type": "Person",
        "name": "SDN-Warrior",
        "url": "https://sdn-warrior.org/about/"
        },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://sdn-warrior.org/posts/migration-with-hcx/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "SDN-Warrior | Daniel Krieger",
      "description": "",
      "logo": {
        "@type": "ImageObject",
        "url": "https://sdn-warrior.org/favicon.ico"
      }
    }
}
</script><title>Migration with HCX</title>
<link rel="stylesheet dns-prefetch preconnect preload prefetch" as="style" href="https://sdn-warrior.org/css/style.min.eb98efc18cb9c6a86651dce801c60b6d61ad5a37f7a6c35512028a9050e32033.css" integrity="sha256-65jvwYy5xqhmUdzoAcYLbWGtWjf3psNVEgKKkFDjIDM=" crossorigin="anonymous">
	<style>.bg-img {background-image: url('/images/net.jpg');}</style></head>
<body id="page">
	<header id="site-header">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://sdn-warrior.org/">SDN-Warrior | Daniel Krieger</a>
				</div>
				<nav class="site-nav hide-in-mobile"><a href="https://sdn-warrior.org/posts/">Posts</a><a href="https://sdn-warrior.org/lab-bom/">Lab BOM</a><a href="https://sdn-warrior.org/links/">Links</a><a href="https://sdn-warrior.org/about/">About Me</a></nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="img-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      <circle cx="8.5" cy="8.5" r="1.5"></circle>
      <polyline points="21 15 16 10 5 21"></polyline>
   </svg></button><span class="hdr-links hide-in-mobile"><a href="https://de.linkedin.com/in/daniel-krieger-6476591a9" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a></span><button id="share-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2">
      <circle cx="18" cy="5" r="3"></circle>
      <circle cx="6" cy="12" r="3"></circle>
      <circle cx="18" cy="19" r="3"></circle>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
   </svg></button>
 
<div id="share-links" class="animated fast">
    
    
    
    
    <ul>
        <li>
            <a href="https://twitter.com/intent/tweet?hashtags=hermit2&amp;url=https%3a%2f%2fsdn-warrior.org%2fposts%2fmigration-with-hcx%2f&amp;text=Migration%20with%20HCX" target="_blank" rel="noopener" aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path class="st0" d="m21.3 21.1 -11.4 -18.2h-7.2l11.4 18.2zm-18.6 0 7.2 -6.6m4.2 -5 7.2 -6.6" />
</svg></a>
        </li>
        <li>
            <a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsdn-warrior.org%2fposts%2fmigration-with-hcx%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg></a>
        </li>
        <li>
            <a href="mailto:?subject=Migration%20with%20HCX&amp;body=https%3a%2f%2fsdn-warrior.org%2fposts%2fmigration-with-hcx%2f" target="_self" rel="noopener" aria-label="Share on Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
   <polyline points="22,6 12,13 2,6"></polyline>
</svg></a>
        </li>
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsdn-warrior.org%2fposts%2fmigration-with-hcx%2f&amp;source=https%3a%2f%2fsdn-warrior.org%2f&amp;title=Migration%20with%20HCX&amp;summary=Migration%20with%20HCX%2c%20by%20SDN-Warrior%0a%0aLive%20Migration%20of%20Workloads%20with%20VMware%20HCX%3a%20A%20Customer%20Story%0a" target="_blank" rel="noopener" aria-label="Share on LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a>
        </li>
        <li>
            <a href="#" onclick="linkShare(&#34;Migration with HCX&#34;,&#34;https://sdn-warrior.org/posts/migration-with-hcx/&#34;,&#34;Migration with HCX, by SDN-Warrior\n\nLive Migration of Workloads with VMware HCX: A Customer Story\n&#34;); return false;" target="_self" rel="noopener" aria-label="Copy Link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
   </svg></a>
        </li>
    </ul>
</div><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
   </svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://sdn-warrior.org/posts/">Posts</a></li>
			<li><a href="https://sdn-warrior.org/lab-bom/">Lab BOM</a></li>
			<li><a href="https://sdn-warrior.org/links/">Links</a></li>
			<li><a href="https://sdn-warrior.org/about/">About Me</a></li>
		</ul>
	</div>


	<div class="bg-img"></div>
	<main class="site-main section-inner animated fadeIn faster"><article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jan 28, 2025</span></div>
				<h1>Migration with HCX</h1>
			</header>
			<div class="post-info"><p>Live Migration of Workloads with VMware HCX: A Customer Story</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
   stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather">
   <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
   <line x1="16" y1="8" x2="2" y2="22"></line>
   <line x1="17.5" y1="15" x2="9" y2="15"></line>
</svg><a href="/about/" target="_blank">SDN-Warrior</a></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon">
      <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
      <line x1="7" y1="7" x2="7" y2="7"></line>
   </svg><span class="tag"><a href="https://sdn-warrior.org/tags/vcf">vcf</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/hcx">hcx</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/vmware">vmware</a></span></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
      <polyline points="10 9 9 9 8 9"></polyline>
   </svg>2450 Words
     Words // ReadTime
    
    
    
    11 Minutes, 8 Seconds</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
   </svg>2025-01-28 20:00 &#43;0100</p></div>
			<hr class="post-end">
			<div class="content">
				<h2 id="introduction">Introduction<a href="#introduction" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>I was brought in to help with a customer project that involved a VCF setup and migrating the workload domains to a new VCF deployment. The challenge of this project was that we had to adopt the existing networks without making any changes while also reducing the downtime of the workloads to an absolute minimum. We used HCX and network extension to solve this problem.</p>
<h2 id="what-is-hcx">What is HCX?<a href="#what-is-hcx" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>VMware HCX is an application mobility platform designed to simplify application migration, workload redeployment, and disaster recovery in data centers and clouds.</p>
<p>HCX covers several use cases:</p>
<ul>
<li>
<p>Plan and install HCX, and the Multi-Site Service Mesh
Build the initial secure pipeline between two connected VMware HCX sites, including connections between associated HCX services.</p>
</li>
<li>
<p>Extend Networks with HCX
Seamlessly extend vSphere and NSX network segments and retain the IP and MAC addresses of migrated VMs to accelerate consumption of modernized resources. Network Extension minimizes the need for complicated networking changes.</p>
</li>
<li>
<p>Migrating Virtual Machines
Select from multiple HCX mobility technologies for optimized migrations at scale for both VMware and non-VMware workloads.</p>
</li>
<li>
<p>Virtual Machine Disaster Recovery
Protect data center applications and workloads through asynchronous replication and recovery of virtual machines, as well as integration with the VMware’s Site Recovery Manager suite of features and tools.</p>
</li>
</ul>
<p>In short, HCX is the answer to my customer problem.</p>
<h2 id="first-things-first-what-are-the-requirements-for-hcx">First things first: what are the requirements for HCX?<a href="#first-things-first-what-are-the-requirements-for-hcx" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Since HCX has been part of VCF since version 5.1.1, many customers have the opportunity to benefit from HCX. For those who want to test VCF, here is the good news: an eval license comes with HCX.

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Eval License</b>
        </div>
        <div class="admonition-content">The eval license has a runtime of 60 days and can migrate a maximum of 20 VMs per migration type.</div>
    </aside></p>
<ul>
<li>
<p>For environments requiring NSX virtual networking, you must install and configure NSX, including integration with the vCenter Server, before deploying HCX Manager.</p>
</li>
<li>
<p>In the destination environment, the NSX Manager must be installed and integrated with the vCenter Server.</p>
</li>
<li>
<p>The NSX Manager must be registered during the HCX Manager install with the admin user.</p>
</li>
<li>
<p>If the NSX Manager IP or FQDN uses self-signed certificates, it might be necessary to trust the NSX system manually using the Import Cert by URL interface in the HCX Appliance Management interface.</p>
</li>
<li>
<p>HCX requires an NSX configured with an Overlay Transport Zone.</p>
</li>
<li>
<p>When NSX-T is registered, both Overlay and VLAN segments can be used during the Network Profile creation.</p>
</li>
<li>
<p>In NSX-T deployments, the HCX supports integration with networking objects created with the NSX Simplified UI/API only.</p>
</li>
</ul>
<h3 id="compute-ressources">Compute Ressources<a href="#compute-ressources" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<table>
  <thead>
      <tr>
          <th>Appliance</th>
          <th>vCPU</th>
          <th>Memory</th>
          <th>Disk Space/IOPS</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>HCX Manager</td>
          <td>4</td>
          <td>12 GB</td>
          <td>60 GB</td>
      </tr>
      <tr>
          <td>HCX Interconnect (HCX-IX)</td>
          <td>8</td>
          <td>6 GB</td>
          <td>2 GB</td>
      </tr>
      <tr>
          <td>HCX Network Extension (HCX-NE)</td>
          <td>8</td>
          <td>3 GB</td>
          <td>2 GB</td>
      </tr>
  </tbody>
</table>
<h3 id="network-ressources">Network Ressources<a href="#network-ressources" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>I need one HCX appliance per workload domain. This needs access to the respective vCenter and the associated NSX manager. In addition, the HCX appliance must be placed in the vMotion network of the respective workload domain. This can be done by routing or the HCX appliance can be given an IP address directly in the vMotion network. I also need at least one uplink VLAN for the HCX appliances to communicate via. This could be done via WAN, for example. For my customer, this is a VLAN in the underlay network.</p>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Info</b>
        </div>
        <div class="admonition-content">Of course, I can&rsquo;t cover all the migration scenarios that are possible with HCX in this article, which is why the requirements also vary. For my scenario at my customer&rsquo;s site, we decided on vMotion migration between the two VCF stacks. In addition, the Network Extension is to be used to minimize downtime.</div>
    </aside>
<h2 id="deploying-and-configuring-hcx-appliance">Deploying and configuring HCX appliance<a href="#deploying-and-configuring-hcx-appliance" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>After deploying the HCX appliance, it must be initially configured. To do this, you have to log in to the management interface via <strong>(https://hcx-ip-or-fqdn:9443)</strong> using the configured admin credentials.
The HCX appliance must have access to the NSX manager, the vCenter must be configured, the public access URL (in my case only internally resolvable) and the SSO domain (vCenter). After successful configuration, you can log in to the HCX appliance with the vCenter credentials. The local admin account only works on the HCX management interface.</p>

<figure><a href="hcx01.png"><picture>
          <source srcset="/hcx/hcx01_hu3247103954367029356.webp" type="image/webp">
          <source srcset="/hcx/hcx01_hu14048880874153927098.jpg" type="image/jpeg">
          <img src="/hcx/hcx01_hu3247103954367029356.webp"alt="HCX settings"  width="1720"  height="804" />
        </picture></a><figcaption>
            <p>HCX settings (click to enlarge)</p>
          </figcaption></figure>
<h2 id="get-started-with-hcx">Get started with HCX<a href="#get-started-with-hcx" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>HCX requires the following: at least one network profile, one compute profile, one or more service mesh and one or more site pairs.</p>
<h3 id="site-pair">Site Pair<a href="#site-pair" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>A Site Pair establishes the connection needed for management, authentication, and orchestration of HCX services across a source and destination environment. To create a new site pair, we need the remote HCX URL, which was configured when deploying the HCX appliance. This must be resolvable via the management network. You also need a vCenter user in the target environment who has sufficient permissions. In my lab I use the vsphere.local administrator. This is of course not best practice and should be adapted in a productive environment.</p>

<figure><a href="hcx04.png"><picture>
          <source srcset="/hcx/hcx04_hu8755679497584188714.webp" type="image/webp">
          <source srcset="/hcx/hcx04_hu15424795913967853680.jpg" type="image/jpeg">
          <img src="/hcx/hcx04_hu8755679497584188714.webp"alt="HCX Site Pair"  width="1496"  height="641" />
        </picture></a><figcaption>
            <p>HCX Site Pair (click to enlarge)</p>
          </figcaption></figure>
<h3 id="network-profiles">Network profiles<a href="#network-profiles" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>After the Site Pair, I set up the network profiles for the interconnect. These profiles allow me to determine the IP addresses and networks. Depending on the setup and service, you need different networks here. In my customer scenario, I can manage with two networks. One profile for management traffic, which I use to access the vCenter and the NSX Manager from environment A. The second network is for the actual uplink connection. In my lab I have 2 uplink networks for testing, so the screenshots may differ slightly. I select the appropriate distributed port group and assign a free IP range. You can define the HCX traffic type, but this is only used as a suggestion in the compute profile. Just because I mark a network profile as an HCX uplink doesn&rsquo;t mean it has to be used as an uplink. It only serves to mark the networks for easier configuration in the compute profile. The vMotion network is routed in my lab. If this is not possible, you can also configure direct access to the vMotion network for the HCX appliance via the network profiles. This is necessary if the vMotion network cannot be routed.</p>

<figure><a href="hcx02.png"><picture>
          <source srcset="/hcx/hcx02_hu246607691319807964.webp" type="image/webp">
          <source srcset="/hcx/hcx02_hu11234734732147992267.jpg" type="image/jpeg">
          <img src="/hcx/hcx02_hu246607691319807964.webp"alt="HCX network profiles settings"  width="1504"  height="821" />
        </picture></a><figcaption>
            <p>HCX network profiles settings (click to enlarge)</p>
          </figcaption></figure>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Free Ip Adresses</b>
        </div>
        <div class="admonition-content">Note: I need one free IP in the MGMT network for each of the following: Pro Network Extension, HCX Appliane and Servicemesh (3 IPs). In the vMotion network, 1 IP is required per service mesh (if the vMotion network is not routed) and at least 1 uplink IP is required per service mesh. The HCX interface offers a calculator for the calculation.</div>
    </aside>
<h3 id="compute-profiles">Compute Profiles<a href="#compute-profiles" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>The compute profiles in HCX are used to specify which HCX services, compute resources such as clusters or resource pools or networks are connected. You can also set CPU and memory reservations for the interconnect appliance. Depending on the HCX service, you have to assign several networks, e.g. management network, uplink networks, vMotion network and the network container. In my case, the network container is the overlay transport zone from my source NSX, as I want to migrate machines from one NSX environment to another NSX environment.</p>

<figure><a href="hcx03.png"><picture>
          <source srcset="/hcx/hcx03_hu5755595554046282005.webp" type="image/webp">
          <source srcset="/hcx/hcx03_hu807890395866389233.jpg" type="image/jpeg">
          <img src="/hcx/hcx03_hu5755595554046282005.webp"alt="HCX Compute profiles settings"  width="1355"  height="937" />
        </picture></a><figcaption>
            <p>HCX Compute profiles settings (click to enlarge)</p>
          </figcaption></figure>
<p>The screenshot shows very clearly how the Interconnect appliance is later connected. The uplinks can be VLAN connections within a data center, public WAN connections, MPLS or VPN. There are very few restrictions here. The uplink networks only need to reach each other between the locations. It does not matter whether it is via Layer2 or Layer3.</p>
<h3 id="service-mesh">Service Mesh<a href="#service-mesh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>In the service mesh, compute profiles, HCX services and advanced configurations such as MTU for uplink links or the number of appliances for the network extension are defined and assigned. After I have configured the service mesh, the interconnect VMs are automatically deployed at both HCX locations.</p>

<figure><a href="hcx05.png"><picture>
          <source srcset="/hcx/hcx05_hu477802228980890625.webp" type="image/webp">
          <source srcset="/hcx/hcx05_hu637616017126372133.jpg" type="image/jpeg">
          <img src="/hcx/hcx05_hu477802228980890625.webp"alt="HCX Service Mesh"  width="2019"  height="611" />
        </picture></a><figcaption>
            <p>HCX Service Mesh (click to enlarge)</p>
          </figcaption></figure>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Service Mesh</b>
        </div>
        <div class="admonition-content">The service mesh cannot be created until both sides of the site pair are configured and have compute and network profiles.</div>
    </aside>
<h2 id="firewall-settings-for-hcx">Firewall Settings for HCX<a href="#firewall-settings-for-hcx" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>After successfully setting up the interconnect compute profile, a firewall port matrix is created that you can easy copy and export over the HCX gui. Here is an example from my lab.</p>
<table>
  <thead>
      <tr>
          <th>Source</th>
          <th>Destination</th>
          <th>Services</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ANY</td>
          <td>ANY</td>
          <td>UDP(3784)</td>
      </tr>
      <tr>
          <td>192.168.70.30-192.168.70.40</td>
          <td>192.168.70.30-192.168.70.40</td>
          <td>UDP(3784), TCP(8182)</td>
      </tr>
      <tr>
          <td>192.168.70.30-192.168.70.40</td>
          <td>192.168.70.10</td>
          <td>TCP(9555)</td>
      </tr>
      <tr>
          <td>192.168.70.30-192.168.70.40</td>
          <td>192.168.12.100</td>
          <td>TCP(443)</td>
      </tr>
      <tr>
          <td>192.168.70.10</td>
          <td>192.168.70.30-192.168.70.40</td>
          <td>TCP(9443)</td>
      </tr>
      <tr>
          <td>192.168.70.10</td>
          <td>192.168.12.100</td>
          <td>TCP(443)</td>
      </tr>
      <tr>
          <td>192.168.70.10</td>
          <td>192.168.12.203, 192.168.12.204</td>
          <td>TCP(902), TCP(80), TCP(443)</td>
      </tr>
      <tr>
          <td>192.168.12.203, 192.168.12.204</td>
          <td>192.168.70.30-192.168.70.40</td>
          <td>TCP(31031), TCP(32032), TCP(44046)</td>
      </tr>
      <tr>
          <td>192.168.70.30-192.168.70.40</td>
          <td>192.168.12.203, 192.168.12.204</td>
          <td>TCP(902), TCP(80)</td>
      </tr>
      <tr>
          <td>192.168.12.203, 192.168.12.204</td>
          <td>192.168.70.30-192.168.70.40</td>
          <td>TCP(8000)</td>
      </tr>
      <tr>
          <td>192.168.70.30-192.168.70.40</td>
          <td>192.168.12.203, 192.168.12.204</td>
          <td>TCP(8000)</td>
      </tr>
      <tr>
          <td>192.168.70.10</td>
          <td>192.168.70.30-192.168.70.40</td>
          <td>TCP(443), TCP(8123), TCP(9443)</td>
      </tr>
      <tr>
          <td>ANY</td>
          <td>172.21.22.10-172.21.22.100, 172.21.21.10-172.21.21.100</td>
          <td>TCP(5201), UDP(4500), UDP(5201)</td>
      </tr>
  </tbody>
</table>
<h2 id="network-extension">Network Extension<a href="#network-extension" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>With the network extension in HCX, layer-2 networks can be extended between the source and target environments without having to change the IP addressing of the workloads. This allows virtual machines to be seamlessly migrated while maintaining their existing network connection and connectivity, and is a prerequisite for a “zero” downtime migration. To create a layer 2 stretch via the network extension, I just have to click on <strong>Network Extension</strong> &raquo; <strong>Create a Network Extension</strong> and select my network that I want to stretch to the other location via HCX. Here I can only choose from networks in my previously configured network container. In my case, these are the networks from my NSX.</p>

<figure><a href="hcx06.png"><picture>
          <source srcset="/hcx/hcx06_hu1336655658149488451.webp" type="image/webp">
          <source srcset="/hcx/hcx06_hu11255365340009955294.jpg" type="image/jpeg">
          <img src="/hcx/hcx06_hu1336655658149488451.webp"alt="HCX Network Extension"  width="1651"  height="1043" />
        </picture></a><figcaption>
            <p>HCX Network Extension (click to enlarge)</p>
          </figcaption></figure>
<p>The stretched  networks are created at the selected T1 router in the target environment and given a prefix. However, the segments are not connected to the T1. The north/south connection is via the T1 and T0 in the source environment. This ensures that no traffic for the VMs is routed into a black hole.</p>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Attention</b>
        </div>
        <div class="admonition-content">For each network that is stretched across the network extension, a network adapter is required on the appliance. Since the appliance is subject to the same limits as all other VMs, a maximum of 10 network adapters can be used. In my case, I lose 1 adapter for management and two adapters for my uplinks. So I can stretch a maximum of 7 NSX networks over this appliance. If I want to stretch more networks, I need another network extension appliance.</div>
    </aside>
<h3 id="how-does-network-extension-work">How does Network Extension work?<a href="#how-does-network-extension-work" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>The sink port on the HCX Network Extension serves as the endpoint for the extended Layer 2 traffic between the source and target environments. It is configured on the source and target sides to receive and send the incoming traffic from the extended network. This can be easily seen on the segment ports in the NSX of the HCX appliance. This is where MAC/IP bindings are exchanged between VMs. If you look at the destination side, you will see (provided that the source VMs are generating traffic) the IP/MAC bindings of the VMs on the source segment on the sink port and vice versa for VMs that have already been migrated to the destination side.</p>

<figure><a href="hcx07.png"><picture>
          <source srcset="/hcx/hcx07_hu16417725051750624200.webp" type="image/webp">
          <source srcset="/hcx/hcx07_hu15694494498939258102.jpg" type="image/jpeg">
          <img src="/hcx/hcx07_hu16417725051750624200.webp"alt="HCX Network Extension Bindings"  width="1024"  height="271" />
        </picture></a><figcaption>
            <p>HCX Network Extension Bindings (click to enlarge)</p>
          </figcaption></figure>
<p>For this to work, special port profiles are created for the segment ports of the HCX Network Extension appliance that allow MAC learning, MAC changing and unknown unicast flooding. By default, the NSX segment profile would prevent this and block it.</p>
<h2 id="migrating-vms">Migrating VMs<a href="#migrating-vms" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>HCX supports a wide range of migration options. Since I aim for zero downtime, I use vMotion as my migration method. For less critical VMs with a maintenance window, a bulk migration with short downtime is also an option. Here you can plan a mass migration and make a controlled switchover at a certain point in time. To do this, a replica of the VMs is created and incrementally synchronized. During the cutover, the final delta data is synchronized and the VM is switched on again. After the migration, the VM is switched on again at the destination. Of course, there are several variants and not every variant is suitable.</p>
<p>vMotion migration in VMware HCX allows me to migrate virtual machines live and without downtime from a source environment to a target environment. HCX uses the vMotion technology but extends it to include the option of migrating workloads in a scheduled manner and across geographically separate data centers.</p>
<p>To plan the migration, I go to <strong>Services</strong> &raquo; <strong>Migration</strong> and create a <strong>NEW Mobility Group</strong>. Here I can set all the relevant migration settings.</p>

<figure><a href="hcx08.png"><picture>
          <source srcset="/hcx/hcx08_hu7678078877074205166.webp" type="image/webp">
          <source srcset="/hcx/hcx08_hu11718259282990917871.jpg" type="image/jpeg">
          <img src="/hcx/hcx08_hu7678078877074205166.webp"alt="HCX New Mobility Group"  width="1627"  height="1157" />
        </picture></a><figcaption>
            <p>HCX New Mobility Group (click to enlarge)</p>
          </figcaption></figure>
<p>The settings are relatively self-explanatory. I select my VMs, choose the target cluster, storage and switchover time, and select my migration method. If the VM comes from a network stretched with the Network Extension, the target network is already preselected. I just have to perform the validation and the migration can start. It is also possible to perform a reverse migration.</p>

<figure><a href="hcx09.png"><picture>
          <source srcset="/hcx/hcx09_hu17883344826524882888.webp" type="image/webp">
          <source srcset="/hcx/hcx09_hu11815756147154765210.jpg" type="image/jpeg">
          <img src="/hcx/hcx09_hu17883344826524882888.webp"alt="HCX Migration"  width="1445"  height="604" />
        </picture></a><figcaption>
            <p>HCX New Mobility Group (click to enlarge)</p>
          </figcaption></figure>
<p>The migration was successful and there was only one ping interruption during the entire migration. The VM was functional and accessible the whole time. Thanks to the network extension, both east/west and north/south traffic works.</p>
<pre tabindex="0"><code>64 bytes from 10.10.20.20: icmp_seq=34 ttl=60 time=6.854 ms
64 bytes from 10.10.20.20: icmp_seq=35 ttl=60 time=2.144 ms
Request timeout for icmp_seq 36
64 bytes from 10.10.20.20: icmp_seq=37 ttl=60 time=11.416 ms
64 bytes from 10.10.20.20: icmp_seq=38 ttl=60 time=4.916 ms
64 bytes from 10.10.20.20: icmp_seq=39 ttl=60 time=3.661 ms
64 bytes from 10.10.20.20: icmp_seq=40 ttl=60 time=3.842 ms

--- 10.10.20.20 ping statistics ---
57 packets transmitted, 56 packets received, 1.8% packet loss
</code></pre><p>After all VMs have been migrated from the source to the target, the network extension for the network via HCX can be removed. If desired, HCX can automatically connect the segments at the target to the T1 router. The segments at the source must then be manually disconnected from the source T1. As long as the same segment subnet is connected to the source and target at the local T1, routing problems may occur. This can be successfully prevented with local preference and AS-Path prepend, by making the segments on the source side less favorable if BGP is used. This only affects north/south connectivity. East/west connectivity is not affected.</p>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>I am aware that I have not even touched on all the functions of HCX. The tool is extremely powerful and you always have to look at the scenario for which you are using the right HCX use case. So I have not addressed the WAN optimization or the MON feature, nor have I gone into detail about the other migration options. The whole thing would go beyond the scope by far and I wanted to write about a scenario that I have already implemented for a customer. I can advise everyone to take a closer look at HCX. With HCX, you have a powerful migration tool that can help you out of unpleasant situations or simply simplifies mass migrations from A to B. Since HCX is now part of the VCF product portfolio, there is no reason not to use the tool.</p>

			</div>
			

<div class="related-posts thin">
	<h2>See Also</h2>
	<ul>
	
	<li><a href="/posts/homelab-v5/">Homelab V5</a></li>
	
	<li><a href="/posts/mac-learning/">MAC Learning is your friend</a></li>
	
	<li><a href="/posts/nsx-apply-to/">How Apply To works in NSX DFW</a></li>
	
	<li><a href="/posts/nsx-tep-groups/">More performance trough NSX Edge TEP groups?</a></li>
	
	<li><a href="/posts/nsx-edge-redeploy/">Redeploy an NSX Edge VM Appliance</a></li>
	
	</ul>
</div>

		</article>
		<div class="post-nav thin">
			<a class="prev-post" href="https://sdn-warrior.org/posts/nsx-apply-to/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right">
      <line x1="5" y1="12" x2="19" y2="12"></line>
      <polyline points="12 5 19 12 12 19"></polyline>
   </svg></span><br><span>How Apply To works in NSX DFW</span>
			</a>
		</div>
		<div id="comments" class="thin"></div>
	</main>

<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>
		&copy; 2025 <a href="https://sdn-warrior.org/">SDN-Warrior</a>
		&#183; COPYRIGHT Daniel Krieger</p>

</footer>
<script async src="https://sdn-warrior.org/js/bundle.min.c7c384e4d29d192bbac6811ae4660bb01767194a5bea56baca77e8260f93ea16.js" integrity="sha256-x8OE5NKdGSu6xoEa5GYLsBdnGUpb6la6ynfoJg+T6hY=" crossorigin="anonymous"></script><script async src="https://sdn-warrior.org/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js" integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin="anonymous"></script>
</body>

</html>
