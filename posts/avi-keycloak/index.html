

<!DOCTYPE html>
<html lang="en-us">
<head>
<script type="text/plain" data-type="application/javascript" data-name="googleAnalytics">
  // Hier kommt dein GA-Code (Google Analytics 4 empfohlen!)
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YNTG7NNKQN', { 'anonymize_ip': true });
</script>

<script type="text/plain" data-type="application/javascript" data-name="googleAnalytics" src="https://www.googletagmanager.com/gtag/js?id=G-YNTG7NNKQN"></script>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="robots" content="index, follow"><link rel="author" href="/humans.txt">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" href="/favicon.ico" type="image/x-icon"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">
<meta name="theme-color" content="#494f5c">
<meta name="msapplication-TileColor" content="#494f5c">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#494f5c"><meta name="author" content="SDN-Warrior"><meta name="description" content="A short blog post on how to connect Keycloak to the AVI load balancer.">

  <meta itemprop="name" content="AVI - Connect Keycloak to AVI Loadbalancer">
  <meta itemprop="description" content="A short blog post on how to connect Keycloak to the AVI load balancer.">
  <meta itemprop="datePublished" content="2026-01-27T21:30:00+01:00">
  <meta itemprop="dateModified" content="2026-01-27T21:30:00+01:00">
  <meta itemprop="wordCount" content="3393">
  <meta itemprop="image" content="https://sdn-warrior.org/images/preview.png">
  <meta itemprop="keywords" content="Vmware,Avi,Homelab,Security,Sso"><meta property="og:url" content="https://sdn-warrior.org/posts/avi-keycloak/">
  <meta property="og:site_name" content="SDN-Warrior | Daniel Krieger">
  <meta property="og:title" content="AVI - Connect Keycloak to AVI Loadbalancer">
  <meta property="og:description" content="A short blog post on how to connect Keycloak to the AVI load balancer.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2026-01-27T21:30:00+01:00">
    <meta property="article:modified_time" content="2026-01-27T21:30:00+01:00">
    <meta property="article:tag" content="Vmware">
    <meta property="article:tag" content="Avi">
    <meta property="article:tag" content="Homelab">
    <meta property="article:tag" content="Security">
    <meta property="article:tag" content="Sso">
    <meta property="og:image" content="https://sdn-warrior.org/images/preview.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://sdn-warrior.org/images/preview.png">
  <meta name="twitter:title" content="AVI - Connect Keycloak to AVI Loadbalancer">
  <meta name="twitter:description" content="A short blog post on how to connect Keycloak to the AVI load balancer.">

<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "AVI - Connect Keycloak to AVI Loadbalancer",
    "name": "AVI - Connect Keycloak to AVI Loadbalancer",
    "description": "A short blog post on how to connect Keycloak to the AVI load balancer.",
    "keywords": ["vmware", "avi", "homelab", "security", "sso"],
    "articleBody": "Introduction Today, I would like to address the topic of how Keycloak can be used as a central identity management system with the Advanced Load Balancer. In theory, this is relatively easy to implement, but in practice, there are a few challenges. I would like to describe exactly what these are and also present a solution. As a little bonus, I will also show you how to use a Fido Key (Yubikey) to log in.\nI must admit, however, that I haven’t had such a frustrating setup in a long time, and it involved a lot of trial and error. Now, OIDC isn’t exactly one of my favorite topics, and I only had rudimentary experience with Keycloak, but that shouldn’t stop me from trying something new. Right? Right! So let’s get started.\nSetup Keycloak At this point, I made it relatively easy for myself by installing the official Keycloak Docker version 26.5.2 on my Unraid. Keycloak requires a Postgres DB, so I used an existing one—also on Unraid. If you were hoping that I would write instructions on how to install Keycloak here, I’m afraid I have to disappoint you.\nInfo\rPasskeys will only be fully supported in version 26.4.0 and above. The feature has been available as a preview since version 23.0.0.\rSince I want to use OKTA as a provider in my VCF setup later on, my Keycloak needs a valid certificate that can be publicly validated. Here, too, I have made it easy for myself and am using my NGINX proxy manager with Let’s Encrypt support and a certificate from one of my domains. So that I don’t have to store my private IPs in Cloudflare’s DNS, I use SplitDNS at home. This means I can resolve keycloak.evilcorp.info, but you cannot. Since most of my Docker containers only run internally with HTTP, I have been using the proxy method for a long time and it has proven to be robust and reliable for me.\nRealm Setup Now that you have somehow deployed Keycloak on your system, we can start with the actual configuration. To do this, you first need to create a new realm. A realm is a client, you could say. A realm has its own users, groups, and so on. In addition, you can define your own identity provider for each realm. In my case, for the sake of simplicity, I use Microsoft AD (because it’s there anyway), but I could also use LinkedIn, Facebook, GitHub, Google, and many other identity providers. A combination of several is also possible. The only important thing is that the username must be unique within the realm. No two identical usernames can exist.\nA new realm can be easily created under Manage realms and only requires a name. I named my realm lab-ad.\nLDAP Connection I deliberately avoided using LDAPs in my lab because my container does not have persistent storage, which means I cannot easily link the RootCA of my domain. This is on my long to-do list, but you can build it properly. An AD is integrated under User federation and not under Identity providers. It sounds strange, but that’s how it is.\nHere are my settings at a glance:\nGeneral options\nUI display name ldap Vendor Active Directory Connection and authentication settings\nConnection URL ldap://home.lab Enable StartTLS Off Use Truststore SPI Never Connection pooling On Connection timeout Bind type simple Bind DN CN=keycloak svc,OU=ServiceAccounts,DC=home,DC=lab Bind credentials •••••••••• LDAP searching and updating\nEdit mode READ_ONLY Users DN OU=User,DC=home,DC=lab Relative user creation DN Username LDAP attribute sAMAccountName RDN LDAP attribute cn UUID LDAP attribute objectGUID User object classes user User LDAP filter (\u0026(objectClass=user)(!(objectClass=computer))) Search scope One Level Read timeout Pagination On Referral Synchronization settings\nImport users On Sync Registrations On Batch size Periodic full sync Off Periodic changed users sync On Changed users sync period 60 Remove invalid users during searches On Kerberos integration\nAllow Kerberos authentication Off Use Kerberos for password authentication Off Cache settings\nCache policy DEFAULT Advanced settings\nEnable the LDAPv3 password modify extended operation Off Validate password policy Off Trust Email Off Connection trace Off This configuration connects Keycloak to an AD server at ldap://home.lab and authenticates there with a service account (CN=keycloak svc,OU=ServiceAccounts), allowing connection and read-only access. Only users in OU=User,DC=home,DC=lab are used, sAMAccountNameis used as the login name, computer objects are filtered out, and the users found are imported into the local database, with changes synchronized every 60 seconds and deleted AD users automatically removed.\nNext, a group-ldap-mapper must be created in the Mappers tab. To do this, simply click on create new mapper and then select the type group-ldap-mapper.\nMy mapper is called ad-groups and these are the settings: ad-groups\nLDAP Groups DN OU=SecGroups,DC=home,DC=lab Relative creation DN Group Name LDAP Attribute cn Group Object Classes group Preserve Group Inheritance Off Ignore Missing Groups Off Membership LDAP Attribute member Membership Attribute Type DN Membership User LDAP Attribute sAMAccountName LDAP Filter Mode READ_ONLY User Groups Retrieve Strategy LOAD_GROUPS_BY_MEMBER_ATTRIBUTE Member-Of LDAP Attribute memberOf Mapped Group Attributes Drop non-existing groups during sync Off Groups Path / These settings tell Keycloak where and how LDAP groups are read: It searches for groups under OU=SecGroups,DC=home,DC=lab, recognizes them as group objects with names from cn, and reads membership via the member attribute (DN-based, users via sAMAccountName). Keycloak works read-only, loads groups via the member attribute, does not automatically transfer missing/unmapped groups, and stores the imported groups under / in the Keycloak group tree.\nOnce LDAP is connected, users should now be found when searching for a user under Users.\nImported AD User in Keycloak (click to enlarge)\nInfo\rFor my test, I created two users, one named “daniel” and one named “dummy.” There are also two AD groups, one named “vcf-admin” and one named “vcf-avi.” My user “daniel” is in both groups. The dummy user is only in the vcf group and serves as a control instance. Access will be regulated later with the groups. Users in the VCF group have access to my vCenter, users without groups have no access, and users in the vcf-avi group have access to the AVI. Does that make sense?\rNext, I create an Auth Profile in AVI. AVI is a bit special in this regard because the Keycloak client must be created with a very specific name.\nAuth Profile AVI In AVI, navigate to Templates -\u003e Security -\u003e Auth Profile and create a new SAML profile.\nInfo\rAVI also offers OAuth/OIDC, but I couldn’t get it to work with any settings. The documentation only mentions that SAML should be used with Workspace One (which we don’t want). OIDC is only described in the documentation for virtual services. Fortunately, the Swiss Army knife Keycloak also supports SAML.\rSAML Settings AVI (click to enlarge)\nTwo things are important here: first, that the IDP metadata URL is used, and second, that the service provider is switched to FQDN. The IDP metadata URL can be found in Keycloak under Realm settings -\u003e General -\u003e Endpoints SAML 2.0 Identity Provider Metadata. Simply click on the browser link and copy the URL from the browser into AVI.\nOnce the profile has been saved, click on the context menu with the three dots in the Auth Profile overview and select Verify. The Verify view displays the Entity ID and the SSO URL—very intuitive—not.\nAttention\rThere are now two very important parameters here. The Entity ID, which must become the Client ID in Keycloak, and the Single Sign-on URL. If either of these is incorrect in the Client Settings, SSO will not work.\rEntity ID: AviController-vcf09-avi.lab.vcf SSO URL: https://vcf09-avi.lab.vcf/sso/acs/ Keycloak Client Keycloak Clients are applications and services that can request authentication of a user. You can have multiple clients in one realm, and clients can have different settings. Such as client-specific roles, for example. I’ll come back to that later, because AVI has a few more peculiarities. A client is created in the realm under Clients.\nCreate client\nClient type SAML Client ID AviController-vcf09-avi.lab.vcf Name AVI - Test Description Always display in UI Off Root URL Home URL Valid redirect URIs https://vcf09-avi.lab.vcf/sso/acs/ Valid post logout redirect URIs https://vcf09-avi.lab.vcf/sso/acs/ IDP-Initiated SSO URL name IDP Initiated SSO Relay State Master SAML Processing URL Those are the basic settings. Next, a few more settings need to be adjusted. To do this, open the client settings—the range of options is overwhelming at first, but fortunately, not much needs to be changed.\nThe first setting must be made in Signature and Encryption. Here, Sign assertions must be set to On. In addition, the name ID format must be changed to email (every user must have an email address in the AD).\nA theme can also be selected under Loging settings. Next, in the Tab Keys, I had to disable the client signature. The problem only occurred when I changed the AVI SSL/TLS Profile and no longer allowed weak ciphers. I haven’t yet figured out exactly where the problem lies. I imported the certificate as described in the AVI documentation, but it only works for me if I allow weak ciphers in AVI. If anyone has any ideas, I would be grateful for any input.\nUnder Roles, I create a new client role called avi-access. I’ll explain what this does a little later. Under Client Scopes, you have to create a Group Mapper, otherwise AVI won’t know anything about the groups. To do this, it’s important to go to the Dedicated scopes, which are named the same as the client, only with -dedicated.\nClient Scope - dedicated (click to enlarge)\nHere, a new mapper must be configured. To do this, press the Configure new mapper button and select a mapper of type Group list.\nGroup attribute name groups Friendly Name AD Groups SAML Attribute NameFormat Basic Single Group Attribute On Full group path Off The Group Mapper in the “Client Dedicated” area ensures that when logging in, the user’s groups are written to the token/SAML assertion for that specific client. Attention\rSo it is important to note that AVI expects a single group attribute. If this is not activated, a separate attribute will be written for each group that a user has in Keycloak. The login will then no longer work if the user is a member of more than one group.\rAVI will need the attribute later for the mapping profile. In the mapping profile, the attribute must have the same name as it was created in Keycloak—in my case, that is “groups”.\nThe SSO URL must be entered under Advanced.\nFine Grain SAML Endpoint Configuration\nThis section to configure exact URLs for Assertion Consumer and Single Logout Service. Logo URL Policy URL Terms of service URL Assertion Consumer Service POST Binding URL https://vcf09-avi.lab.vcf/sso/acs/ Assertion Consumer Service Redirect Binding URL https://vcf09-avi.lab.vcf/sso/acs/ Logout Service POST Binding URL Logout Service Redirect Binding URL Logout Service SOAP Binding URL Logout Service ARTIFACT Binding URL Artifact Binding URL Artifact Resolution Service This completes the initial configuration of the client. However, do not be concerned, as we will need to configure more later on.\nRole mapping for AVI Next, we use the aforementioned client role. This role can only be used in the AVI client in Keycloak. With this, we will prevent a peculiarity of AVI. AVI has a strange habit of creating a user in AVI as soon as authentication is complete, regardless of whether the user has access or not. Currently, all I have to do is create a valid Keycloak session for a user, who is then created in AVI and receives an error message because they are not authorized. The only problem is that this creates a defective SAML cookie and you can no longer log in to AVI, even if you try with a valid user. Great, I can already see the tickets coming in. The solution is to delete the cookie in the browser and end the session in Keycloak. After that, you can log in again. Of course, you now have a user without authorization in AVI, which you must delete manually.\nSAML Cookie broken (click to enlarge)\nIn general, this behavior is not a security issue, but user complaints are inevitable. To prevent this, I am building in a check to see whether the user is authorized to access the AVI. The check is performed at the Keycloak level, and the request is not sent to the AVI at all if there is no authorization for AVI.\nTo do this, a role mapping must be created in Keycloak. Under Groups -\u003e vcf-avi -\u003e Role Mapping, a role can be assigned to the group in Keycloak. The groups and user membership come from the AD, making it easy to manage centrally. To assign the role, click Assign role and select the appropriate client role avi-access via client roles.\nAuth Mapping Profile for AVI I promise, we’ll soon be able to log in with Keycloak. An Auth Mapping Profile is still required in AVI. This can be created under Templates -\u003e Security -\u003e Auth Mapping Profile. It must be a SAML type profile. The profile is given a descriptive name and requires a rule. I’ll keep it simple in this example and say that all users whose SAML attribute contains vcf-avi become super users. Remember, the SAML attribute contains all Keycloak groups. You could also write a RegEX, because with Contains I have the problem that a group named vcf-avi-test would also match. But I’ll leave that to the people who have to implement it in production.\nAVI Mapping Profile (click to enlarge)\nFinally, the Auth profile and the Mapping Profile just need to be assigned.\nAVI Authentication settings You can do this easily under Administration -\u003e System Settings and then edit them. Under Authentication, you must switch from Local to Remote. The Enable Local User Login checkbox should be selected, otherwise you will not be able to log in locally if SSO fails. Finally, map the Auth Profile with the Mapping Profile, and then we’re done and can run our first test.\nFirst Test If everything works correctly, after accessing the AVI page, a message should automatically appear stating that you are not logged in, and the Keycloak login screen should appear directly via the login link.\nKeycloak SSO (click to enlarge)\nYou can log in with either your username or your email address. Because I was smart enough to use my private email address, you can only see the username here.\nAVI User (click to enlarge)\nAttention\rYou can log in with a local user by using this link\nhttps://avi-url/#!/login?local=1 Interim conclusion SSO login via Keycloak should work, but unfortunately it is not yet possible to log in with a FIDO key, and there is still no way to prevent the dummy user from logging in to AVI, or rather, from being rejected by AVI, which breaks our SAML cookie. Time to change that. So grab a coffee, because this article could go on for quite a while.\nEnable Fido Key To use a Yubikey or similar device, a few options need to be set in Keycloak. Passwordless login is also supported, but I’m not personally a fan of this. However, the activation process is similar. First, in the Realm Settings under Authentication -\u003e Required actions -\u003e Webauth Register, set Enabled and Set as default action. For passwordless login, the corresponding option Webauthn Register Passwordless must be activated and set as the default action. Without the default action, users will not be asked to create a passkey when they log in for the first time.\nAttention\rIf you have already used users to log in, they must be deleted in Keycloak after you have activated the option. Thanks to AD sync, the users will be back in no time.\rThen, under Authentication -\u003e Policies -\u003e WebAuthn Policy or WebAuthn Passwordless Policy, the policy must be activated. To do this, WebAuthn -\u003e Avoid same authenticator registration should be activated, or, in the case of WebAuthn Passwordless Policy, this option and enable passkeys in general.\nWebauthn Settings (click to enlarge)\nFlow Finally, a flow must be created under Authentication -\u003e Flows. I use the built-in browser-based authentication flow as a basis and create a copy via the context menu. In order to use the client role in the flow, the flow must be assigned to the client. To do this, the flow you just created must be assigned under Clients -\u003e AviController-xxx -\u003e Advanced -\u003e Authentication flow overrides. This allows each client to have its own flow and different checks or login methods.\nA flow consists of three key elements. There are steps (executions), which are specific actions in the login process, such as deny access. Secondly, there are conditions, which are ways of checking something, such as whether the user has a certain role, and finally there are sub-flows, which can be used to group steps and conditions. In addition, each element has a requirement that determines whether the login continues or is terminated. In short, a flow is a chain of steps, conditions, and sub-flows with rules that control the login process.\nFlow (click to enlarge)\nTo activate keypasses, WebAuthn must be configured in the flow and set to required. Next, a subflow of type generel must be created. This can be done using the small plus sign. It is important that the subflow is in the correct position at the end and is indented correctly. The subflow is used to check role membership. The subflow must be dragged and dropped into the correct position. It is sometimes easier to do this by dragging other elements upwards. The subflow must also be set to Conditional. The conditional block is only executed if the previous step is TRUE. In this flow, 2FA must have been successfully completed, otherwise the login will be canceled. Next, a condition and a step must be created using the plus sign. Both must be defined as required, otherwise the check will not be performed and, in the event of a missing authorization, Access denied will not be executed. The condition must be of type user role, and client roles must be selected under select role. Then I select the avi-access role and select Negate output. Negate Output ensures that the condition is set to TRUE if the user does not have the avi-access role. If the condition is TRUE, the step deny access is executed. If the user has the role, the condition is FALSE and the flow is terminated with the result that I have access. If everything has been done correctly, the flow should look like the screenshot. “Indentation” is just as important here as it is in YAML.\nFlow details (click to enlarge)\nNow that everything is configured, it should work roughly as shown in this video.\nTroubleshooting Troubleshooting can be very time-consuming, and I had a few problems. I could bet that I logged into AVI at least 300 times in the last two days. So here are a few general tips.\nDelete your cookies. Even if it is open in an anonymous tab, cookie remnants may remain during runtime, and in case of doubt, this is a broken SAML cookie that then prevents even valid logins. Always delete the session in Keycloak. Just because you log out of AVI does not mean that the SSO session is also closed. When dragging and dropping in Flow, elements may automatically deactivate if they are moved to an invalid position, for example. Keycloak attempts to save immediately after moving. This nearly drove me to distraction. Sometimes it makes more sense to move other elements than the element you actually want to move. Enables logging in Keycloak. This is configured in the Realm Settings under Events. If parts of the flow were not executed, the position of the sub-flow should be checked to see if it was nested correctly. If “access denied” is displayed despite correct role assignment, the negation in the condition was probably forgotten. We are sorry…(to be honest, I’m not.)\nSummary Keycloak or OIDC is a damn powerful toolkit. However, it is anything but simple and, unfortunately, extremely poorly documented for AVI load balancers. I actually wanted to write down the configuration for the VCF client, but the blog article is becoming so extensive that most people probably won’t read it anyway, so I’d rather pick up the whole thing again in a second article.\n",
    "wordCount" : "3393",
    "inLanguage": "en",
    "image":"https://sdn-warrior.org/images/key.jpg","datePublished": "2026-01-27T21:30:00+01:00",
    "dateModified": "2026-01-27T21:30:00+01:00",
    "author":{
        "@type": "Person",
        "name": "SDN-Warrior",
        "url": "https://sdn-warrior.org/about/"
        },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://sdn-warrior.org/posts/avi-keycloak/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "SDN-Warrior | Daniel Krieger",
      "description": "",
      "logo": {
        "@type": "ImageObject",
        "url": "https://sdn-warrior.org/favicon.ico"
      }
    }
}
</script><title>AVI - Connect Keycloak to AVI Loadbalancer</title>
<link rel="stylesheet dns-prefetch preconnect preload prefetch" as="style" href="https://sdn-warrior.org/css/style.min.4a710a7c0d2021c556818ee82d473cb9b2609d3edea5ab7e43529e3680d670ad.css" integrity="sha256-SnEKfA0gIcVWgY7oLUc8ubJgnT7epat+Q1KeNoDWcK0=" crossorigin="anonymous">
	<style>.bg-img {background-image: url('/images/key.jpg');}</style></head>
<body id="page">
	<header id="site-header">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://sdn-warrior.org/">SDN-Warrior | Daniel Krieger</a>
				</div>
				<nav class="site-nav hide-in-mobile"><a href="https://sdn-warrior.org/posts/">Posts</a><a href="https://sdn-warrior.org/lab-bom/">Lab BOM</a><a href="https://sdn-warrior.org/links/">Links</a><a href="https://sdn-warrior.org/about/">About Me</a></nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="img-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      <circle cx="8.5" cy="8.5" r="1.5"></circle>
      <polyline points="21 15 16 10 5 21"></polyline>
   </svg></button><span class="hdr-links hide-in-mobile"><a href="https://de.linkedin.com/in/daniel-krieger-6476591a9" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a></span><button id="share-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2">
      <circle cx="18" cy="5" r="3"></circle>
      <circle cx="6" cy="12" r="3"></circle>
      <circle cx="18" cy="19" r="3"></circle>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
   </svg></button>
 
<div id="share-links" class="animated fast">
    
    
    
    
    <ul>
        <li>
            <a href="https://twitter.com/intent/tweet?hashtags=hermit2&amp;url=https%3a%2f%2fsdn-warrior.org%2fposts%2favi-keycloak%2f&amp;text=AVI%20-%20Connect%20Keycloak%20to%20AVI%20Loadbalancer" target="_blank" rel="noopener" aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path class="st0" d="m21.3 21.1 -11.4 -18.2h-7.2l11.4 18.2zm-18.6 0 7.2 -6.6m4.2 -5 7.2 -6.6" />
</svg></a>
        </li>
        <li>
            <a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsdn-warrior.org%2fposts%2favi-keycloak%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg></a>
        </li>
        <li>
            <a href="mailto:?subject=AVI%20-%20Connect%20Keycloak%20to%20AVI%20Loadbalancer&amp;body=https%3a%2f%2fsdn-warrior.org%2fposts%2favi-keycloak%2f" target="_self" rel="noopener" aria-label="Share on Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
   <polyline points="22,6 12,13 2,6"></polyline>
</svg></a>
        </li>
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsdn-warrior.org%2fposts%2favi-keycloak%2f&amp;source=https%3a%2f%2fsdn-warrior.org%2f&amp;title=AVI%20-%20Connect%20Keycloak%20to%20AVI%20Loadbalancer&amp;summary=AVI%20-%20Connect%20Keycloak%20to%20AVI%20Loadbalancer%2c%20by%20SDN-Warrior%0a%0aA%20short%20blog%20post%20on%20how%20to%20connect%20Keycloak%20to%20the%20AVI%20load%20balancer.%0a" target="_blank" rel="noopener" aria-label="Share on LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a>
        </li>
        <li>
            <a href="#" onclick="linkShare(&#34;AVI - Connect Keycloak to AVI Loadbalancer&#34;,&#34;https://sdn-warrior.org/posts/avi-keycloak/&#34;,&#34;AVI - Connect Keycloak to AVI Loadbalancer, by SDN-Warrior\n\nA short blog post on how to connect Keycloak to the AVI load balancer.\n&#34;); return false;" target="_self" rel="noopener" aria-label="Copy Link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
   </svg></a>
        </li>
    </ul>
</div><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
   </svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://sdn-warrior.org/posts/">Posts</a></li>
			<li><a href="https://sdn-warrior.org/lab-bom/">Lab BOM</a></li>
			<li><a href="https://sdn-warrior.org/links/">Links</a></li>
			<li><a href="https://sdn-warrior.org/about/">About Me</a></li>
		</ul>
	</div>


	<div class="bg-img"></div>
	<main class="site-main section-inner animated fadeIn faster"><article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jan 27, 2026</span></div>
				<h1>AVI - Connect Keycloak to AVI Loadbalancer</h1>
			</header>
			<div class="post-info"><p>A short blog post on how to connect Keycloak to the AVI load balancer.</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
   stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather">
   <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
   <line x1="16" y1="8" x2="2" y2="22"></line>
   <line x1="17.5" y1="15" x2="9" y2="15"></line>
</svg><a href="/about/" target="_blank">SDN-Warrior</a></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon">
      <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
      <line x1="7" y1="7" x2="7" y2="7"></line>
   </svg><span class="tag"><a href="https://sdn-warrior.org/tags/vmware">vmware</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/avi">avi</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/homelab">homelab</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/security">security</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/sso">sso</a></span></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
      <polyline points="10 9 9 9 8 9"></polyline>
   </svg>3393 Words
     // ReadTime
    
    
    
    15 Minutes, 25 Seconds</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
   </svg>2026-01-27 21:30 &#43;0100</p></div>
			<hr class="post-end">
			<div class="content">
				<h2 id="introduction">Introduction<a href="#introduction" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Today, I would like to address the topic of how Keycloak can be used as a central identity management system with the Advanced Load Balancer.
In theory, this is relatively easy to implement, but in practice, there are a few challenges.
I would like to describe exactly what these are and also present a solution.
As a little bonus, I will also show you how to use a Fido Key (Yubikey) to log in.</p>
<p>I must admit, however, that I haven&rsquo;t had such a frustrating setup in a long time, and it involved a lot of trial and error.
Now, OIDC isn&rsquo;t exactly one of my favorite topics, and I only had rudimentary experience with Keycloak, but that shouldn&rsquo;t stop me from trying something new. Right? Right! So let&rsquo;s get started.</p>
<h2 id="setup-keycloak">Setup Keycloak<a href="#setup-keycloak" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>At this point, I made it relatively easy for myself by installing the official Keycloak Docker version 26.5.2 on my Unraid.
Keycloak requires a Postgres DB, so I used an existing one—also on Unraid.
If you were hoping that I would write instructions on how to install Keycloak here, I&rsquo;m afraid I have to disappoint you.</p>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Info</b>
        </div>
        <div class="admonition-content">Passkeys will only be fully supported in version 26.4.0 and above. The feature has been available as a preview since version 23.0.0.</div>
    </aside>
<p>Since I want to use OKTA as a provider in my VCF setup later on, my Keycloak needs a valid certificate that can be publicly validated.
Here, too, I have made it easy for myself and am using my NGINX proxy manager with Let&rsquo;s Encrypt support and a certificate from one of my domains.
So that I don&rsquo;t have to store my private IPs in Cloudflare&rsquo;s DNS, I use SplitDNS at home. This means I can resolve keycloak.evilcorp.info, but you cannot.
Since most of my Docker containers only run internally with HTTP, I have been using the proxy method for a long time and it has proven to be robust and reliable for me.</p>
<h3 id="realm-setup">Realm Setup<a href="#realm-setup" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Now that you have somehow deployed Keycloak on your system, we can start with the actual configuration. To do this, you first need to create a new realm.
A realm is a client, you could say. A realm has its own users, groups, and so on.
In addition, you can define your own identity provider for each realm. In my case, for the sake of simplicity, I use Microsoft AD (because it&rsquo;s there anyway), but I could also use LinkedIn, Facebook, GitHub, Google, and many other identity providers. A combination of several is also possible.
The only important thing is that the username must be unique within the realm. No two identical usernames can exist.</p>
<p>A new realm can be easily created under Manage realms and only requires a name. I named my realm lab-ad.</p>
<h3 id="ldap-connection">LDAP Connection<a href="#ldap-connection" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>I deliberately avoided using LDAPs in my lab because my container does not have persistent storage, which means I cannot easily link the RootCA of my domain.
This is on my long to-do list, but you can build it properly.
An AD is integrated under User federation and not under Identity providers. It sounds strange, but that&rsquo;s how it is.</p>
<p>Here are my settings at a glance:</p>
<p>General options</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">UI display name ldap
</span></span><span class="line"><span class="cl">Vendor Active Directory
</span></span></code></pre></div><p>Connection and authentication settings</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Connection URL ldap://home.lab
</span></span><span class="line"><span class="cl">Enable StartTLS Off
</span></span><span class="line"><span class="cl">Use Truststore SPI Never
</span></span><span class="line"><span class="cl">Connection pooling On
</span></span><span class="line"><span class="cl">Connection timeout 
</span></span><span class="line"><span class="cl">Bind type simple
</span></span><span class="line"><span class="cl">Bind DN CN=keycloak svc,OU=ServiceAccounts,DC=home,DC=lab
</span></span><span class="line"><span class="cl">Bind credentials ••••••••••
</span></span></code></pre></div><p>LDAP searching and updating</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Edit mode READ_ONLY
</span></span><span class="line"><span class="cl">Users DN OU=User,DC=home,DC=lab
</span></span><span class="line"><span class="cl">Relative user creation DN 
</span></span><span class="line"><span class="cl">Username LDAP attribute sAMAccountName
</span></span><span class="line"><span class="cl">RDN LDAP attribute cn
</span></span><span class="line"><span class="cl">UUID LDAP attribute objectGUID
</span></span><span class="line"><span class="cl">User object classes user
</span></span><span class="line"><span class="cl">User LDAP filter (&amp;(objectClass=user)(!(objectClass=computer)))
</span></span><span class="line"><span class="cl">Search scope One Level
</span></span><span class="line"><span class="cl">Read timeout 
</span></span><span class="line"><span class="cl">Pagination On
</span></span><span class="line"><span class="cl">Referral 
</span></span></code></pre></div><p>Synchronization settings</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Import users On
</span></span><span class="line"><span class="cl">Sync Registrations On
</span></span><span class="line"><span class="cl">Batch size 
</span></span><span class="line"><span class="cl">Periodic full sync Off
</span></span><span class="line"><span class="cl">Periodic changed users sync On
</span></span><span class="line"><span class="cl">Changed users sync period 60
</span></span><span class="line"><span class="cl">Remove invalid users during searches On
</span></span></code></pre></div><p>Kerberos integration</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Allow Kerberos authentication Off
</span></span><span class="line"><span class="cl">Use Kerberos for password authentication Off
</span></span></code></pre></div><p>Cache settings</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Cache policy DEFAULT
</span></span></code></pre></div><p>Advanced settings</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Enable the LDAPv3 password modify extended operation Off
</span></span><span class="line"><span class="cl">Validate password policy Off
</span></span><span class="line"><span class="cl">Trust Email Off
</span></span><span class="line"><span class="cl">Connection trace Off
</span></span></code></pre></div><p>This configuration connects Keycloak to an AD server at ldap://home.lab and authenticates there with a service account (CN=keycloak svc,OU=ServiceAccounts), allowing connection and read-only access.
Only users in OU=User,DC=home,DC=lab are used, sAMAccountNameis used as the login name, computer objects are filtered out, and the users found are imported into the local database, with changes synchronized every 60 seconds and deleted AD users automatically removed.</p>
<p>Next, a group-ldap-mapper must be created in the Mappers tab. To do this, simply click on create new mapper and then select the type group-ldap-mapper.</p>
<p>My mapper is called ad-groups and these are the settings:
ad-groups</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">LDAP Groups DN OU=SecGroups,DC=home,DC=lab
</span></span><span class="line"><span class="cl">Relative creation DN 
</span></span><span class="line"><span class="cl">Group Name LDAP Attribute cn
</span></span><span class="line"><span class="cl">Group Object Classes group
</span></span><span class="line"><span class="cl">Preserve Group Inheritance Off
</span></span><span class="line"><span class="cl">Ignore Missing Groups Off
</span></span><span class="line"><span class="cl">Membership LDAP Attribute member
</span></span><span class="line"><span class="cl">Membership Attribute Type DN
</span></span><span class="line"><span class="cl">Membership User LDAP Attribute sAMAccountName
</span></span><span class="line"><span class="cl">LDAP Filter 
</span></span><span class="line"><span class="cl">Mode READ_ONLY
</span></span><span class="line"><span class="cl">User Groups Retrieve Strategy LOAD_GROUPS_BY_MEMBER_ATTRIBUTE
</span></span><span class="line"><span class="cl">Member-Of LDAP Attribute memberOf
</span></span><span class="line"><span class="cl">Mapped Group Attributes 
</span></span><span class="line"><span class="cl">Drop non-existing groups during sync Off
</span></span><span class="line"><span class="cl">Groups Path /
</span></span></code></pre></div><p>These settings tell Keycloak where and how LDAP groups are read: It searches for groups under OU=SecGroups,DC=home,DC=lab, recognizes them as group objects with names from cn, and reads membership via the member attribute (DN-based, users via sAMAccountName).
Keycloak works read-only, loads groups via the member attribute, does not automatically transfer missing/unmapped groups, and stores the imported groups under / in the Keycloak group tree.</p>
<p>Once LDAP is connected, users should now be found when searching for a user under Users.</p>

<figure><a href="01.png"><picture>
          <source srcset="/avi-keycloak/01_hu_1bb1b99d2f1b3bd2.webp" type="image/webp">
          <source srcset="/avi-keycloak/01_hu_f0087a59af78c34f.jpg" type="image/jpeg">
          <img src="/avi-keycloak/01_hu_1bb1b99d2f1b3bd2.webp"alt="User"  width="3448"  height="1972" />
        </picture></a><figcaption>
            <p>Imported AD User in Keycloak (click to enlarge)</p>
          </figcaption></figure>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Info</b>
        </div>
        <div class="admonition-content">For my test, I created two users, one named “daniel” and one named “dummy.” There are also two AD groups, one named “vcf-admin” and one named “vcf-avi.” My user “daniel” is in both groups. The dummy user is only in the vcf group and serves as a control instance.
Access will be regulated later with the groups. Users in the VCF group have access to my vCenter, users without groups have no access, and users in the vcf-avi group have access to the AVI. Does that make sense?</div>
    </aside>
<p>Next, I create an Auth Profile in AVI. AVI is a bit special in this regard because the Keycloak client must be created with a very specific name.</p>
<h3 id="auth-profile-avi">Auth Profile AVI<a href="#auth-profile-avi" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>In AVI, navigate to Templates -&gt; Security -&gt; Auth Profile and create a new SAML profile.</p>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Info</b>
        </div>
        <div class="admonition-content">AVI also offers OAuth/OIDC, but I couldn&rsquo;t get it to work with any settings.
The documentation only mentions that SAML should be used with Workspace One (which we don&rsquo;t want). OIDC is only described in the documentation for virtual services. Fortunately, the Swiss Army knife Keycloak also supports SAML.</div>
    </aside>

<figure><a href="02.png"><picture>
          <source srcset="/avi-keycloak/02_hu_580b8a10a0c11376.webp" type="image/webp">
          <source srcset="/avi-keycloak/02_hu_a7352be9040a7d3d.jpg" type="image/jpeg">
          <img src="/avi-keycloak/02_hu_580b8a10a0c11376.webp"alt="SAML"  width="1245"  height="1063" />
        </picture></a><figcaption>
            <p>SAML Settings AVI (click to enlarge)</p>
          </figcaption></figure>
<p>Two things are important here: first, that the IDP metadata URL is used, and second, that the service provider is switched to FQDN.
The IDP metadata URL can be found in Keycloak under Realm settings -&gt; General -&gt; Endpoints SAML 2.0 Identity Provider Metadata.
Simply click on the browser link and copy the URL from the browser into AVI.</p>
<p>Once the profile has been saved, click on the context menu with the three dots in the Auth Profile overview and select Verify.
The Verify view displays the Entity ID and the SSO URL—very intuitive—not.</p>

    <aside class="admonition attention">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24"
      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
   </svg></div><b>Attention</b>
        </div>
        <div class="admonition-content">There are now two very important parameters here.
The Entity ID, which must become the Client ID in Keycloak, and the Single Sign-on URL. If either of these is incorrect in the Client Settings, SSO will not work.</div>
    </aside>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Entity ID: AviController-vcf09-avi.lab.vcf
</span></span><span class="line"><span class="cl">SSO URL: https://vcf09-avi.lab.vcf/sso/acs/
</span></span></code></pre></div><h3 id="keycloak-client">Keycloak Client<a href="#keycloak-client" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Keycloak Clients are applications and services that can request authentication of a user.
You can have multiple clients in one realm, and clients can have different settings.
Such as client-specific roles, for example. I&rsquo;ll come back to that later, because AVI has a few more peculiarities.
A client is created in the realm under Clients.</p>
<p>Create client</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Client type SAML
</span></span><span class="line"><span class="cl">Client ID AviController-vcf09-avi.lab.vcf
</span></span><span class="line"><span class="cl">Name AVI - Test
</span></span><span class="line"><span class="cl">Description 
</span></span><span class="line"><span class="cl">Always display in UI Off
</span></span><span class="line"><span class="cl">Root URL 
</span></span><span class="line"><span class="cl">Home URL 
</span></span><span class="line"><span class="cl">Valid redirect URIs https://vcf09-avi.lab.vcf/sso/acs/
</span></span><span class="line"><span class="cl">Valid post logout redirect URIs https://vcf09-avi.lab.vcf/sso/acs/
</span></span><span class="line"><span class="cl">IDP-Initiated SSO URL name 
</span></span><span class="line"><span class="cl">IDP Initiated SSO Relay State 
</span></span><span class="line"><span class="cl">Master SAML Processing URL 
</span></span></code></pre></div><p>Those are the basic settings. Next, a few more settings need to be adjusted. To do this, open the client settings—the range of options is overwhelming at first, but fortunately, not much needs to be changed.</p>
<p>The first setting must be made in Signature and Encryption. Here, Sign assertions must be set to On.
In addition, the name ID format must be changed to email (every user must have an email address in the AD).</p>
<p>A theme can also be selected under Loging settings.
Next, in the Tab Keys, I had to disable the client signature. The problem only occurred when I changed the AVI SSL/TLS Profile and no longer allowed weak ciphers.
I haven&rsquo;t yet figured out exactly where the problem lies.
I imported the certificate as described in the AVI documentation, but it only works for me if I allow weak ciphers in AVI.
If anyone has any ideas, I would be grateful for any input.</p>
<p>Under Roles, I create a new client role called avi-access. I&rsquo;ll explain what this does a little later.
Under Client Scopes, you have to create a Group Mapper, otherwise AVI won&rsquo;t know anything about the groups.
To do this, it&rsquo;s important to go to the Dedicated scopes, which are named the same as the client, only with -dedicated.</p>

<figure><a href="03.png"><picture>
          <source srcset="/avi-keycloak/03_hu_e0f89724ac3518c9.webp" type="image/webp">
          <source srcset="/avi-keycloak/03_hu_e4fdf97b6dac5d1a.jpg" type="image/jpeg">
          <img src="/avi-keycloak/03_hu_e0f89724ac3518c9.webp"alt="Client Scope - dedicvated"  width="3446"  height="1962" />
        </picture></a><figcaption>
            <p>Client Scope - dedicated  (click to enlarge)</p>
          </figcaption></figure>
<p>Here, a new mapper must be configured. To do this, press the Configure new mapper button and select a mapper of type Group list.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Group attribute name groups
</span></span><span class="line"><span class="cl">Friendly Name AD Groups
</span></span><span class="line"><span class="cl">SAML Attribute NameFormat Basic
</span></span><span class="line"><span class="cl">Single Group Attribute On
</span></span><span class="line"><span class="cl">Full group path Off
</span></span></code></pre></div><p>The Group Mapper in the “Client Dedicated” area ensures that when logging in, the user&rsquo;s groups are written to the token/SAML assertion for that specific client.

    <aside class="admonition attention">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24"
      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
   </svg></div><b>Attention</b>
        </div>
        <div class="admonition-content">So it is important to note that AVI expects a single group attribute. If this is not activated, a separate attribute will be written for each group that a user has in Keycloak. The login will then no longer work if the user is a member of more than one group.</div>
    </aside></p>
<p>AVI will need the attribute later for the mapping profile. In the mapping profile, the attribute must have the same name as it was created in Keycloak—in my case, that is “groups”.</p>
<p>The SSO URL must be entered under Advanced.</p>
<p>Fine Grain SAML Endpoint Configuration</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">This section to configure exact URLs for Assertion Consumer and Single Logout Service.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Logo URL 
</span></span><span class="line"><span class="cl">Policy URL 
</span></span><span class="line"><span class="cl">Terms of service URL 
</span></span><span class="line"><span class="cl">Assertion Consumer Service POST Binding URL https://vcf09-avi.lab.vcf/sso/acs/
</span></span><span class="line"><span class="cl">Assertion Consumer Service Redirect Binding URL https://vcf09-avi.lab.vcf/sso/acs/
</span></span><span class="line"><span class="cl">Logout Service POST Binding URL 
</span></span><span class="line"><span class="cl">Logout Service Redirect Binding URL 
</span></span><span class="line"><span class="cl">Logout Service SOAP Binding URL 
</span></span><span class="line"><span class="cl">Logout Service ARTIFACT Binding URL 
</span></span><span class="line"><span class="cl">Artifact Binding URL 
</span></span><span class="line"><span class="cl">Artifact Resolution Service 
</span></span></code></pre></div><p>This completes the initial configuration of the client. However, do not be concerned, as we will need to configure more later on.</p>
<h3 id="role-mapping-for-avi">Role mapping for AVI<a href="#role-mapping-for-avi" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Next, we use the aforementioned client role. This role can only be used in the AVI client in Keycloak.
With this, we will prevent a peculiarity of AVI. AVI has a strange habit of creating a user in AVI as soon as authentication is complete, regardless of whether the user has access or not.
Currently, all I have to do is create a valid Keycloak session for a user, who is then created in AVI and receives an error message because they are not authorized.
The only problem is that this creates a defective SAML cookie and you can no longer log in to AVI, even if you try with a valid user. Great, I can already see the tickets coming in.
The solution is to delete the cookie in the browser and end the session in Keycloak. After that, you can log in again. Of course, you now have a user without authorization in AVI, which you must delete manually.</p>

<figure><a href="04.png"><picture>
          <source srcset="/avi-keycloak/04_hu_cafe7f76754fb7cf.webp" type="image/webp">
          <source srcset="/avi-keycloak/04_hu_b418f339ca25a99d.jpg" type="image/jpeg">
          <img src="/avi-keycloak/04_hu_cafe7f76754fb7cf.webp"alt="SAML Cookie broken"  width="1160"  height="737" />
        </picture></a><figcaption>
            <p>SAML Cookie broken (click to enlarge)</p>
          </figcaption></figure>
<p>In general, this behavior is not a security issue, but user complaints are inevitable.
To prevent this, I am building in a check to see whether the user is authorized to access the AVI.
The check is performed at the Keycloak level, and the request is not sent to the AVI at all if there is no authorization for AVI.</p>
<p>To do this, a role mapping must be created in Keycloak. Under Groups -&gt; vcf-avi -&gt; Role Mapping, a role can be assigned to the group in Keycloak. The groups and user membership come from the AD, making it easy to manage centrally.
To assign the role, click Assign role and select the appropriate client role avi-access via client roles.</p>
<h3 id="auth-mapping-profile-for-avi">Auth Mapping Profile for AVI<a href="#auth-mapping-profile-for-avi" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>I promise, we&rsquo;ll soon be able to log in with Keycloak. An Auth Mapping Profile is still required in AVI.
This can be created under Templates -&gt; Security -&gt; Auth Mapping Profile. It must be a SAML type profile.
The profile is given a descriptive name and requires a rule.
I&rsquo;ll keep it simple in this example and say that all users whose SAML attribute contains vcf-avi become super users.
Remember, the SAML attribute contains all Keycloak groups. You could also write a RegEX, because with Contains I have the problem that a group named vcf-avi-test would also match.
But I&rsquo;ll leave that to the people who have to implement it in production.</p>

<figure><a href="05.png"><picture>
          <source srcset="/avi-keycloak/05_hu_f56d80f74c6b94c6.webp" type="image/webp">
          <source srcset="/avi-keycloak/05_hu_4b9005acfde1af92.jpg" type="image/jpeg">
          <img src="/avi-keycloak/05_hu_f56d80f74c6b94c6.webp"alt="AVI Mapping Profile"  width="2802"  height="1964" />
        </picture></a><figcaption>
            <p>AVI Mapping Profile (click to enlarge)</p>
          </figcaption></figure>
<p>Finally, the Auth profile and the Mapping Profile just need to be assigned.</p>
<h3 id="avi-authentication-settings">AVI Authentication settings<a href="#avi-authentication-settings" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>You can do this easily under Administration -&gt; System Settings and then edit them.
Under Authentication, you must switch from Local to Remote.
The Enable Local User Login checkbox should be selected, otherwise you will not be able to log in locally if SSO fails.
Finally, map the Auth Profile with the Mapping Profile, and then we&rsquo;re done and can run our first test.</p>
<h3 id="first-test">First Test<a href="#first-test" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>If everything works correctly, after accessing the AVI page, a message should automatically appear stating that you are not logged in, and the Keycloak login screen should appear directly via the login link.</p>

<figure><a href="06.png"><picture>
          <source srcset="/avi-keycloak/06_hu_5dfc1aebea067eb9.webp" type="image/webp">
          <source srcset="/avi-keycloak/06_hu_520d49a6921746f3.jpg" type="image/jpeg">
          <img src="/avi-keycloak/06_hu_5dfc1aebea067eb9.webp"alt="Keycloak SSO"  width="3452"  height="1964" />
        </picture></a><figcaption>
            <p>Keycloak SSO (click to enlarge)</p>
          </figcaption></figure>
<p>You can log in with either your username or your email address.
Because I was smart enough to use my private email address, you can only see the username here.</p>

<figure><a href="07.png"><picture>
          <source srcset="/avi-keycloak/07_hu_8d631eb35aca51b5.webp" type="image/webp">
          <source srcset="/avi-keycloak/07_hu_8ad83fe99dc1799c.jpg" type="image/jpeg">
          <img src="/avi-keycloak/07_hu_8d631eb35aca51b5.webp"alt="AVI SSO"  width="3444"  height="1944" />
        </picture></a><figcaption>
            <p>AVI User (click to enlarge)</p>
          </figcaption></figure>

    <aside class="admonition attention">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24"
      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
   </svg></div><b>Attention</b>
        </div>
        <div class="admonition-content"><p>You can log in with a local user by using this link</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">https://avi-url/#!/login?local=1 
</span></span></code></pre></div></div>
    </aside>
<h2 id="interim-conclusion">Interim conclusion<a href="#interim-conclusion" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>SSO login via Keycloak should work, but unfortunately it is not yet possible to log in with a FIDO key, and there is still no way to prevent the dummy user from logging in to AVI, or rather, from being rejected by AVI, which breaks our SAML cookie.
Time to change that. So grab a coffee, because this article could go on for quite a while.</p>
<h3 id="enable-fido-key">Enable Fido Key<a href="#enable-fido-key" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>To use a Yubikey or similar device, a few options need to be set in Keycloak.
Passwordless login is also supported, but I&rsquo;m not personally a fan of this.
However, the activation process is similar. First, in the Realm Settings under Authentication -&gt; Required actions -&gt; Webauth Register, set Enabled and Set as default action.
For passwordless login, the corresponding option Webauthn Register Passwordless must be activated and set as the default action.
Without the default action, users will not be asked to create a passkey when they log in for the first time.</p>

    <aside class="admonition attention">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24"
      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
   </svg></div><b>Attention</b>
        </div>
        <div class="admonition-content">If you have already used users to log in, they must be deleted in Keycloak after you have activated the option.
Thanks to AD sync, the users will be back in no time.</div>
    </aside>
<p>Then, under Authentication -&gt; Policies -&gt; WebAuthn Policy or WebAuthn Passwordless Policy, the policy must be activated. To do this, WebAuthn -&gt; Avoid same authenticator registration should be activated, or, in the case of WebAuthn Passwordless Policy, this option and enable passkeys in general.</p>

<figure><a href="08.png"><picture>
          <source srcset="/avi-keycloak/08_hu_8341e5833f220d26.webp" type="image/webp">
          <source srcset="/avi-keycloak/08_hu_bfa6eb9a8360bd05.jpg" type="image/jpeg">
          <img src="/avi-keycloak/08_hu_8341e5833f220d26.webp"alt="Webauthn"  width="1719"  height="1358" />
        </picture></a><figcaption>
            <p>Webauthn Settings (click to enlarge)</p>
          </figcaption></figure>
<h3 id="flow">Flow<a href="#flow" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Finally, a flow must be created under Authentication -&gt; Flows. I use the built-in browser-based authentication flow as a basis and create a copy via the context menu.
In order to use the client role in the flow, the flow must be assigned to the client. To do this, the flow you just created must be assigned under Clients -&gt; AviController-xxx -&gt; Advanced -&gt; Authentication flow overrides. This allows each client to have its own flow and different checks or login methods.</p>
<p>A flow consists of three key elements. There are steps (executions), which are specific actions in the login process, such as deny access.
Secondly, there are conditions, which are ways of checking something, such as whether the user has a certain role, and finally there are sub-flows, which can be used to group steps and conditions.
In addition, each element has a requirement that determines whether the login continues or is terminated.
In short, a flow is a chain of steps, conditions, and sub-flows with rules that control the login process.</p>

<figure><a href="09.png"><picture>
          <source srcset="/avi-keycloak/09_hu_9c062aaad32c052c.webp" type="image/webp">
          <source srcset="/avi-keycloak/09_hu_4a5f08665e36a680.jpg" type="image/jpeg">
          <img src="/avi-keycloak/09_hu_9c062aaad32c052c.webp"alt="Flow"  width="1721"  height="1325" />
        </picture></a><figcaption>
            <p>Flow (click to enlarge)</p>
          </figcaption></figure>
<ul>
<li>
<ol>
<li>To activate keypasses, WebAuthn must be configured in the flow and set to required.</li>
</ol>
</li>
<li>
<ol start="2">
<li>Next, a subflow of type generel must be created. This can be done using the small plus sign. It is important that the subflow is in the correct position at the end and is indented correctly. The subflow is used to check role membership.</li>
</ol>
</li>
<li>
<ol start="3">
<li>The subflow must be dragged and dropped into the correct position. It is sometimes easier to do this by dragging other elements upwards. The subflow must also be set to Conditional. The conditional block is only executed if the previous step is TRUE. In this flow, 2FA must have been successfully completed, otherwise the login will be canceled.</li>
</ol>
</li>
<li>
<ol start="4">
<li>Next, a condition and a step must be created using the plus sign. Both must be defined as required, otherwise the check will not be performed and, in the event of a missing authorization, Access denied will not be executed.</li>
</ol>
</li>
<li>
<ol start="5">
<li>The condition must be of type user role, and client roles must be selected under select role. Then I select the avi-access role and select Negate output. Negate Output ensures that the condition is set to TRUE if the user does not have the avi-access role. If the condition is TRUE, the step deny access is executed. If the user has the role, the condition is FALSE and the flow is terminated with the result that I have access.</li>
</ol>
</li>
</ul>
<p>If everything has been done correctly, the flow should look like the screenshot. &ldquo;Indentation&rdquo; is just as important here as it is in YAML.</p>

<figure><a href="10.png"><picture>
          <source srcset="/avi-keycloak/10_hu_28e513a10e9b0b95.webp" type="image/webp">
          <source srcset="/avi-keycloak/10_hu_33f1094a40d7b874.jpg" type="image/jpeg">
          <img src="/avi-keycloak/10_hu_28e513a10e9b0b95.webp"alt="Flow details"  width="1712"  height="1319" />
        </picture></a><figcaption>
            <p>Flow details (click to enlarge)</p>
          </figcaption></figure>
<p>Now that everything is configured, it should work roughly as shown in this video.</p>
<div class="video-container">
  <iframe width="560" height="315"
    src="https://www.youtube-nocookie.com/embed/MHD71gCeZMw"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
  </iframe>
</div>
<h2 id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Troubleshooting can be very time-consuming, and I had a few problems. I could bet that I logged into AVI at least 300 times in the last two days. So here are a few general tips.</p>
<ul>
<li>Delete your cookies. Even if it is open in an anonymous tab, cookie remnants may remain during runtime, and in case of doubt, this is a broken SAML cookie that then prevents even valid logins.</li>
<li>Always delete the session in Keycloak. Just because you log out of AVI does not mean that the SSO session is also closed.</li>
<li>When dragging and dropping in Flow, elements may automatically deactivate if they are moved to an invalid position, for example. Keycloak attempts to save immediately after moving. This nearly drove me to distraction. Sometimes it makes more sense to move other elements than the element you actually want to move.</li>
<li>Enables logging in Keycloak. This is configured in the Realm Settings under Events.</li>
<li>If parts of the flow were not executed, the position of the sub-flow should be checked to see if it was nested correctly.</li>
<li>If “access denied” is displayed despite correct role assignment, the negation in the condition was probably forgotten.</li>
</ul>

<figure><a href="11.png"><picture>
          <source srcset="/avi-keycloak/11_hu_a9ad6e42e7d25aaa.webp" type="image/webp">
          <source srcset="/avi-keycloak/11_hu_d5215e44b63a8590.jpg" type="image/jpeg">
          <img src="/avi-keycloak/11_hu_a9ad6e42e7d25aaa.webp"alt="Sorry"  width="2016"  height="1326" />
        </picture></a><figcaption>
            <p>We are sorry&hellip;(to be honest, I&rsquo;m not.)</p>
          </figcaption></figure>
<h2 id="summary">Summary<a href="#summary" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Keycloak or OIDC is a damn powerful toolkit. However, it is anything but simple and, unfortunately, extremely poorly documented for AVI load balancers. I actually wanted to write down the configuration for the VCF client, but the blog article is becoming so extensive that most people probably won&rsquo;t read it anyway, so I&rsquo;d rather pick up the whole thing again in a second article.</p>

			</div>
			<div class="human posts"><a href="https://brainmade.org/" target="_blank" rel="external noreferrer noopener"><abbr title="I don't hate AIs; but I love humans!"><svg fill="#fff" width="128" height="40" viewBox="0 0 128 40" xmlns="http://www.w3.org/2000/svg">
      <path
         d="M26.306 39.391H11.665a1.28 1.28 0 0 1-1.28-1.28v-3.838H6.399a1.28 1.28 0 0 1-1.28-1.28v-5.336l-4.41-2.198a1.28 1.28 0 0 1-.493-1.855l4.904-7.357v-2.175C5.12 6.298 11.422 0 19.194 0s14.073 6.3 14.075 14.071c-.316 13.912-5.38 11.758-5.59 17.023l-.093 7.018a1.3 1.3 0 0 1-.375.905 1.27 1.27 0 0 1-.905.375zm-13.361-2.559h12.082l.143-7.27c-.132-3.329 5.858-4.122 5.54-15.368-.179-6.356-5.157-11.635-11.515-11.635S7.68 7.713 7.679 14.071v2.559c-.001.253-.075.5-.215.71l-4.315 6.471 3.822 1.91a1.28 1.28 0 0 1 .708 1.145v4.848h3.987a1.28 1.28 0 0 1 1.28 1.28z" />
      <path
         d="M20.186 29.111v-9.644c.059 0 .118.009.177.009 4.885-.006 8.525-4.506 7.511-9.284a1.19 1.19 0 0 0-.911-.911 7.67 7.67 0 0 0-9.049 5.67l-.033-.036a7.66 7.66 0 0 0-7.03-2.085 1.19 1.19 0 0 0-.911.91c-1.014 4.777 2.627 9.277 7.51 9.284.118 0 .246-.014.369-.02v6.106zm1.419-16.072a5.33 5.33 0 0 1 4.062-1.553 5.33 5.33 0 0 1-5.614 5.615 5.3 5.3 0 0 1 1.552-4.061zm-7.904 6.057a5.3 5.3 0 0 1-1.559-4.061 5.323 5.323 0 0 1 5.614 5.615 5.3 5.3 0 0 1-4.055-1.554m38.419-6.79q0 2.346-1.567 3.63-1.567 1.282-4.351 1.283h-7.669V0h7.016q2.807 0 4.242 1.1 1.446 1.087 1.446 3.226 0 1.467-.729 2.481-.718 1.002-2.197 1.357 1.86.244 2.828 1.32.979 1.063.979 2.823zm-4.112-7.491q0-1.161-.663-1.65-.652-.488-1.947-.488h-3.655v4.265h3.677q1.36 0 1.968-.525.62-.537.62-1.601m.892 7.209q0-2.42-3.089-2.42h-4.069v4.938h4.188q1.545 0 2.252-.624.718-.635.718-1.894m16.26 5.194-3.557-6.538h-3.764v6.538H54.63V0h7.658q2.741 0 4.231 1.332 1.49 1.32 1.49 3.8 0 1.808-.913 3.128-.914 1.308-2.47 1.723l4.144 7.235zm-.381-11.94q0-2.481-2.828-2.481h-4.112v5.083h4.199q1.349 0 2.045-.684.696-.685.696-1.919m16.785 11.94-1.36-4.399h-5.841l-1.359 4.399h-3.209L75.386 0h3.785l5.569 17.219zM77.278 2.651l-.066.269q-.109.44-.261 1.002c-.152.563-.725 2.436-1.871 6.184h4.405l-1.512-4.949-.468-1.662zm9.551 14.567V0h3.209v17.219zm15.53 0L95.681 3.959q.196 1.931.196 3.104v10.155h-2.849V0h3.666l6.777 13.37q-.196-1.846-.196-3.361V0h2.85v17.219zM52.63 39.375V28.331q.011-.351.115-3.015-.818 3.257-1.209 4.541l-2.925 9.518h-2.418l-2.925-9.518-1.232-4.541q.139 2.809.139 3.717v10.342h-3.017V22.313h4.548l2.902 9.543.253.92.553 2.289.725-2.736 2.983-10.015h4.526v17.063zm17.64 0-1.44-4.359h-6.184l-1.44 4.359h-3.397l5.919-17.063h4.007l5.896 17.063zm-4.537-14.434-.069.267q-.115.436-.277.993c-.162.557-.767 2.414-1.98 6.128h4.663l-1.601-4.905-.495-1.647zm24.577 5.776q0 2.64-.99 4.614-.979 1.961-2.787 3.003-1.796 1.042-4.122 1.042h-6.564V22.313h5.873q4.099 0 6.345 2.18 2.245 2.167 2.245 6.224m-3.42 0q0-2.748-1.359-4.19-1.359-1.453-3.881-1.453h-2.407v11.54h2.879q2.188 0 3.478-1.586t1.29-4.311m6 8.659V22.313h12.759v2.761h-9.362v4.287h8.66v2.761h-8.66v4.492h9.835v2.761zm15.75 0v-3.693h3.328v3.693zm12.445-12.149q2.082 0 3.662.781 1.58.78 2.422 2.235.833 1.454.833 3.393 0 2.98-1.845 4.676Q124.302 40 121.085 40q-3.208 0-5.005-1.688-1.798-1.688-1.798-4.695c0-3.007.606-3.57 1.817-4.694q1.817-1.696 4.986-1.696m0 2.702q-2.157 0-3.378.97-1.23.97-1.23 2.72 0 1.777 1.22 2.747 1.211.97 3.388.97 2.195 0 3.462-.988 1.258-.997 1.258-2.711 0-1.778-1.23-2.738-1.23-.97-3.491-.97m6.725-13.402-5.062 2.935v3.107h5.062v2.648h-13.331v-6.322q0-2.261 1.031-3.491 1.022-1.23 2.942-1.23 1.4 0 2.422.754 1.012.754 1.334 2.038l5.601-3.42zm-9.244.314q-1.92 0-1.921 2.334v3.393h3.936v-3.465q0-1.113-.53-1.688t-1.486-.575m7.249-10.915a6.5 6.5 0 0 0-.313-2.002q-.321-.969-.814-1.499h-1.845v3.088h-2.063V0h4.901q1.088 1.005 1.703 2.622a9.4 9.4 0 0 1 .615 3.375q0 3.088-1.798 4.748-1.808 1.661-5.119 1.661-3.292 0-5.043-1.67-1.76-1.67-1.76-4.803 0-4.452 3.473-5.664l.776 2.442q-1.012.395-1.533 1.238-.52.844-.52 1.984 0 1.867 1.192 2.837t3.416.97q2.261 0 3.501-.997 1.23-1.005 1.23-2.818z" />
   </svg></abbr></a></div>
			<div class="post-divider">
  				<img src="/end.png" alt="End graphic" loading="lazy">
			</div>

<div class="related-posts thin">
	<h2>See Also</h2>
	<ul>
	
	<li><a href="/posts/vcf9-operations-dashboard/">VCF9 - Building a VCF Operations Dashboard</a></li>
	
	<li><a href="/posts/vcf9-nsx-vpc-part3/">VCF 9 - NSX VPC Part 3 - Security</a></li>
	
	<li><a href="/posts/nsx-expiring-tn-certificates/">NSX Expiring Transport Node Certificates</a></li>
	
	<li><a href="/posts/vcf-stretched-cluster/">VCF Stretched Cluster</a></li>
	
	<li><a href="/posts/vcf-import-overlay/">VCF Import Tool - Enable Overlay in an imported VCF Domain</a></li>
	
	</ul>
</div>

		</article>
		<div class="post-nav thin">
			<a class="prev-post" href="https://sdn-warrior.org/posts/vcf9-automation-all-apps/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right">
      <line x1="5" y1="12" x2="19" y2="12"></line>
      <polyline points="12 5 19 12 12 19"></polyline>
   </svg></span><br><span>VCF9 - Automation in All Apps mode</span>
			</a>
		</div>
		<div id="comments" class="thin"></div>
	</main>

<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>
		&copy; 2026 <a href="https://sdn-warrior.org/">SDN-Warrior</a>
		&#183; COPYRIGHT Daniel Krieger</p>

<script defer src="/klaro/klaro-config.js"></script>

<script defer src="/klaro/klaro.js"></script>
</footer>
<script async src="https://sdn-warrior.org/js/bundle.min.c7c384e4d29d192bbac6811ae4660bb01767194a5bea56baca77e8260f93ea16.js" integrity="sha256-x8OE5NKdGSu6xoEa5GYLsBdnGUpb6la6ynfoJg+T6hY=" crossorigin="anonymous"></script><script async src="https://sdn-warrior.org/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js" integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin="anonymous"></script>
</body>

</html>
