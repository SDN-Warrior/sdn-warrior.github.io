

<!DOCTYPE html>
<html lang="en-us">
<head>
<script type="text/plain" data-type="application/javascript" data-name="googleAnalytics">
  // Hier kommt dein GA-Code (Google Analytics 4 empfohlen!)
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YNTG7NNKQN', { 'anonymize_ip': true });
</script>

<script type="text/plain" data-type="application/javascript" data-name="googleAnalytics" src="https://www.googletagmanager.com/gtag/js?id=G-YNTG7NNKQN"></script>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="robots" content="index, follow"><link rel="author" href="/humans.txt">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" href="/favicon.ico" type="image/x-icon"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">
<meta name="theme-color" content="#494f5c">
<meta name="msapplication-TileColor" content="#494f5c">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#494f5c"><meta name="author" content="SDN-Warrior"><meta name="description" content="A short article on how to build a stretched vSAN cluster in the VCF.">

  <meta itemprop="name" content="VCF Stretched Cluster">
  <meta itemprop="description" content="A short article on how to build a stretched vSAN cluster in the VCF.">
  <meta itemprop="datePublished" content="2025-03-13T23:00:00+01:00">
  <meta itemprop="dateModified" content="2025-03-13T23:00:00+01:00">
  <meta itemprop="wordCount" content="2183">
  <meta itemprop="image" content="https://sdn-warrior.org/images/logo.jpg">
  <meta itemprop="keywords" content="Vmware,Vcf,Homelab,Broadcom"><meta property="og:url" content="https://sdn-warrior.org/posts/vcf-stretched-cluster/">
  <meta property="og:site_name" content="SDN-Warrior | Daniel Krieger">
  <meta property="og:title" content="VCF Stretched Cluster">
  <meta property="og:description" content="A short article on how to build a stretched vSAN cluster in the VCF.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-13T23:00:00+01:00">
    <meta property="article:modified_time" content="2025-03-13T23:00:00+01:00">
    <meta property="article:tag" content="Vmware">
    <meta property="article:tag" content="Vcf">
    <meta property="article:tag" content="Homelab">
    <meta property="article:tag" content="Broadcom">
    <meta property="og:image" content="https://sdn-warrior.org/images/logo.jpg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://sdn-warrior.org/images/logo.jpg">
  <meta name="twitter:title" content="VCF Stretched Cluster">
  <meta name="twitter:description" content="A short article on how to build a stretched vSAN cluster in the VCF.">

<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "VCF Stretched Cluster",
    "name": "VCF Stretched Cluster",
    "description": "A short article on how to build a stretched vSAN cluster in the VCF.",
    "keywords": ["vmware", "vcf", "homelab", "broadcom"],
    "articleBody": "Introduction This is my third article in my VCF Homelab series. On second thought, I may have put the cart before the horse, because a stretched vSAN cluster requires a functioning management domain. But ok, that shouldn’t bother us now. I’ll try to cover all the essentials of the deployment in this article.\nWhat are the benefits of a stretched vSAN cluster and why does it have to be vSAN? Well, first the obvious. We have to use vSAN because we have a consolidated design here and VCF (version 5.2.1) does not allow any other principal storage in the consolidated design (also, this article is about a vSAN stretched cluster). Secondly, we want to use the synchronous replication of vSAN to the second site. Another reason is “German Angst”. We want to have redundancy here and a muti AZ design. In Germany, there have traditionally been stretched clusters across multiple fire compartments or buildings for a long time. In the past, I myself have already implemented such scenarios with layer 2 over layer 3 (aka VxLAN). The much more elegant way (and also the way supported by VCF) is the vSAN stretched cluster.\nLet’s get started Of course, as always, there is a flip side to the coin. We can’t just stretch a workload domain and all is well. This is certainly not possible via the GUI of the SDDC Manager. Yes, that’s right, we will work with the API. But more on that later. If we think about using one or more stretched workload domains, this always means that we also have to stretch our management domain. This gives us the following requirements:\n8 ESXi servers for our Management Domain (4 per AZ) Minimum 6 ESXi servers for Workload Domain (8 recommanded minimum) Both availability zones must contain an equal number of hosts to ensure failover in case any of the availability zones goes down. Redundant L3 gateways A set of VLANs A vSAN Witness Host (ESA or OSA Wthness Appliance) You cannot stretch a cluster in the following conditions:\nThe cluster is a vSAN Max cluster. The cluster has a vSAN remote datastore mounted on it. The cluster shares a vSAN Storage Policy with any other clusters. The cluster includes DPU-backed hosts. Latency vSphere\nLess than 150 ms latency RTT for vCenter Server connectivity. Less than 150 ms latency RTT for vMotion connectivity. Less than 5 ms latency RTT for VSAN hosts connectivity. Latency vSAN Site to Witness\nLess than 200 ms latency RTT for up to 10 hosts per site. Less than 100 ms latency RTT for 11-15 hosts per site. Latency NSX Managers\nLess than 10 ms latency RTT between NSX Managers Less than 150 ms latency RTT between NSX Managers and transport nodes. Info\rI will only explain the stretching of the management domain in my article, as my resources in the lab are not infinite and the process is identical for the workload domain.\rVLANs Function Availability Zone 1 Availability Zone 2 HA Layer 3 Gateway Recommended MTU VM Management VLAN ✓ ✓ ✓ 1500 Management VLAN (AZ1) ✓ X ✓ 1500 vMotion VLAN ✓ X ✓ 9000 vSAN VLAN (AZ1) ✓ X ✓ 9000 NSX Host Overlay VLAN ✓ X ✓ 9000 NSX Edge Uplink01 VLAN ✓ ✓ X 9000 NSX Edge Uplink02 VLAN ✓ ✓ X 9000 NSX Edge Overlay VLAN ✓ ✓ ✓ 9000 Management VLAN (AZ2) X ✓ ✓ 1500 vMotion VLAN (AZ2) X ✓ ✓ 9000 vSAN VLAN (AZ2) X ✓ ✓ 9000 NSX Host Overlay VLAN (AZ2) X ✓ ✓ 9000 In your Lab setup you can also use 1700 byte MTU instead of 9000 byte mtu. Redundant gateways are heavily dependent on the physical network design. For a spine/leaf network with top of rack switches, you can use VRRP, HSRP or anycast gateway technology, depending on the manufacturer, expected traffic, fabric design and so on. It depends heavily on the underlay design which is the right one here. In my setup, I have implemented the gateways on my top of rack switch.\nDeploy vSAN Witness Host A vSAN Witness Host is required for a Stretched vSAN Cluster. Ready-made appliances can be downloaded from the Broadcom support portal. These are delivered as OVA and must be deployed on a third independent site. vSAN Witness can be connected either Layer 2 or Layer 3.\nBest Practice\rThe recommended way would be a layer 3 connection and each site has an independent routed connection to the Witness Appliance.\rAfter the successful deployment, the witness host must be registered in the vCenter of the management domain. You must add the vSAN witness host to the datacenter. Do not add it to a folder. Use the fully qualified domain name (FQDN) of the vSAN witness host, not the IP address. There are a few adjustments to be made to the witness host:\nRemove the dedicated VMkernel adapter for witness traffic on the vSAN witness host. Remove the network port group from the virtual machine on the vSAN witness host. Enable witness traffic on the VMkernel adapter for the management network of the vSAN witness host. A step-by-step guide can be found in the VCF 5.2 Administration Guide.\nCommission Host As I already wrote in the intro, I assume for the article that a management domain is already deployed, but that it is not yet a stretched cluster. The physical network is configured and all VLANs and IP networks are available. Another network pool is also required. The vSAN and vMotion network is defined in this network pool.\nNetwork Pool (click to enlarge)\nNow that the preparations are complete, I can add the additional hosts in the sddc manager. These must have the same build as the existing hosts in the cluster. If, for example, the MGMT domain has been patched with ESXi patches to a different build than is in the BoM of VCF 5.2.1, then the additional hosts must be updated to the same version before they are provisioned.\nSDDC Manager (click to enlarge)\nAfter the hosts have been successfully commissioned in the SDDC manager, its not allowed to add them to the existing management domain. Next, the cluster stretch spec must be created – this is the fun part of the deployment.\nStretch a vSAN Cluster (aka Fun Part) Unfortunately, the actual stretch of the cluster cannot be conveniently carried out in the SDDC GUI. A JSON cluster stretch spec must be created and then passed to the SDDC manager via an API call.\nAttention\rThe ESXi hosts that you are adding to availability zone 2 must use the same vmnic to vSphere Distributed Switch mapping as the existing hosts in availability zone 1.\rThe ESXi host ID is required for the JSON. This can be read out via an API call. The easiest way to do this is to use the Developer Center in the SDDC. Of course, any API tool will also work. At this point, I was just too lazy to generate an API token and did all the queries in the developer center of the SDDC manager.\nDeveloper Center (click to enlarge)\nThe answer contains the IDs of the ESX servers, which can be easily transferred to the Cluster Stretch Spec. My Cluster Stretch Spec looks like this:\n{ \"clusterStretchSpec\": { \"hostSpecs\": [ { \"hostname\": \"vcf02-m01-esx05.lab.home\", \"hostNetworkSpec\": { \"networkProfileName\": \"sfo-w01-az2-nsx-np01\", \"vmNics\": [ { \"id\": \"vmnic0\", \"uplink\": \"uplink1\", \"vdsName\": \"sfo-m01-vds1\" }, { \"id\": \"vmnic1\", \"uplink\": \"uplink2\", \"vdsName\": \"sfo-m01-vds1\" } ] }, \"id\": \"2bb45762-b2b9-4d94-8003-980f32d449f2\", \"licenseKey\": \"XXXX-XXXXX-XXXXX-XXXXX-XXXXX\" }, { \"hostname\": \"vcf02-m01-esx06.lab.home\", \"hostNetworkSpec\": { \"networkProfileName\": \"sfo-w01-az2-nsx-np01\", \"vmNics\": [ { \"id\": \"vmnic0\", \"uplink\": \"uplink1\", \"vdsName\": \"sfo-m01-vds1\" }, { \"id\": \"vmnic1\", \"uplink\": \"uplink2\", \"vdsName\": \"sfo-m01-vds1\" } ] }, \"id\": \"a1fafaf3-bb88-4ee6-9a1b-a7ca0e8e9c47\", \"licenseKey\": \"XXXX-XXXXX-XXXXX-XXXXX-XXXXX\" }, { \"hostname\": \"vcf02-m01-esx07.lab.home\", \"hostNetworkSpec\": { \"networkProfileName\": \"sfo-w01-az2-nsx-np01\", \"vmNics\": [ { \"id\": \"vmnic0\", \"uplink\": \"uplink1\", \"vdsName\": \"sfo-m01-vds1\" }, { \"id\": \"vmnic1\", \"uplink\": \"uplink2\", \"vdsName\": \"sfo-m01-vds1\" } ] }, \"id\": \"a8ece8a4-9264-4b05-8637-02cbc0a85f45\", \"licenseKey\": \"XXXX-XXXXX-XXXXX-XXXXX-XXXXX\" }, { \"hostname\": \"vcf02-m01-esx08.lab.home\", \"hostNetworkSpec\": { \"networkProfileName\": \"sfo-w01-az2-nsx-np01\", \"vmNics\": [ { \"id\": \"vmnic0\", \"uplink\": \"uplink1\", \"vdsName\": \"sfo-m01-vds1\" }, { \"id\": \"vmnic1\", \"uplink\": \"uplink2\", \"vdsName\": \"sfo-m01-vds1\" } ] }, \"id\": \"c4e8e06f-5229-4d3c-86a3-a9f0f76fdea2\", \"licenseKey\": \"XXXX-XXXXX-XXXXX-XXXXX-XXXXX\" } ], \"isEdgeClusterConfiguredForMultiAZ\": false, \"networkSpec\": { \"networkProfiles\": [ { \"isDefault\": false, \"name\": \"sfo-w01-az2-nsx-np01\", \"nsxtHostSwitchConfigs\": [ { \"uplinkProfileName\": \"sfo-w01-az2-host-uplink-profile01\", \"vdsName\": \"sfo-m01-vds1\", \"vdsUplinkToNsxUplink\": [ { \"nsxUplinkName\": \"uplink-1\", \"vdsUplinkName\": \"uplink1\" }, { \"nsxUplinkName\": \"uplink-2\", \"vdsUplinkName\": \"uplink2\" } ] } ] } ], \"nsxClusterSpec\": { \"uplinkProfiles\": [ { \"name\": \"sfo-w01-az2-host-uplink-profile01\", \"teamings\": [ { \"activeUplinks\": [ \"uplink-1\", \"uplink-2\" ], \"name\": \"DEFAULT\", \"policy\": \"LOADBALANCE_SRCID\", \"standByUplinks\": [] } ], \"transportVlan\": 1011 } ] } }, \"witnessSpec\": { \"fqdn\": \"vcf02-osa.lab.home\", \"vsanCidr\": \"192.168.12.0/24\", \"vsanIp\": \"192.168.12.22\" }, \"witnessTrafficSharedWithVsanTraffic\": false } } Next, the cluster stretch spec can be validated.The cluster ID is required for this.\nThis is also done as an API call. To do this, I go to the Developer Center, then to the managing clusters section, expand GET /v1/cluster end execute the API call.\nHere is a small excerpt of what the response looks like. The correct ID is “id”: “e04c96fe-263c-4355-bdcf-7464b03e35d2”. The domain ID must not be used.\n{ \"elements\": [ { \"id\": \"e04c96fe-263c-4355-bdcf-7464b03e35d2\", \"domain\": { \"id\": \"40a61f61-0686-4514-b6a9-ba47c8533be9\" }, \"name\": \"sfo-m01-cluster-001\", \"status\": \"ACTIVE\", \"primaryDatastoreName\": \"m01-cluster-001-vsan\", \"primaryDatastoreType\": \"VSAN\", \"hosts\": [ { \"id\": \"034f44ca-1654-450c-915f-6d3e072bee68\" }, { \"id\": \"2bb45762-b2b9-4d94-8003-980f32d449f2\" }, { \"id\": \"7cdd8928-575d-44b0-a604-834d3dd0bf13\" }, { \"id\": \"9cbbe32f-31ce-450a-863c-31c39e248ab0\" } To perform the validate cluster stretch spec, I’ll expand the “APIs for managing clusters” section and expand POST /v1/clusters/{id}/validations. I enter the unique ID for the management cluster in the id text field. In addition, the cluster stretch spec must be copied into the body field.\nCluster Stretch Spec Validation (click to enlarge)\nAfter the validation has been successfully completed, the cluster can be stretched. To start the actual task, another API call must be made. This time PATCH /v1/clusters/{id}. The process is the same as for the validation. I copy the cluster ID into the ID field and copy the cluster stretch spec into the body field. After executing, the cluster stretch begins. This can be followed in the SDDC in the task bar.\nCluster Stretch (click to enlarge)\nDepending on the performance of the environment, the process may take some time. For me, it was comparable to the duration of the bring-on of the unstretched management domain. If the task has been completed successfully, the SDDC and the vCenter should look like the following screenshots.\nStretched Cluster SDDC (click to enlarge)\nStretched Cluster vCenter (click to enlarge)\nStorage Policy\rWhen you stretch a cluster, VMware Cloud Foundation modifies the site disaster tolerance setting for storage policy associated with datastore of that cluster from None - standard cluster to Site mirroring - stretched cluster. This affects all VMs using default datastore policy in that cluster.\rNotes Further stretched cluster operations can be carried out via API. A cluster expand or a cluster unstretch must currently still be carried out via API. You also need to think about BGP peering. Depending on the setup, each side has its own AS number for BGP and Broadcom recommends working with route maps and local preference to control traffic. Personally, I would say: it depends. However, this topic is so extensive that it may get its own blog article at some point. In addition, you have to worry about the placement of VMs, storage policies and much more…\nOpinion\rDesign is always a matter of opinions and there is usually not just one perfect solution.\rLab Hardware and Sizing of the VMs Perhaps a brief word about the resources used. I could have set up the lab more economically. There is potential for savings in the NSX managers, where only one manager would have been needed with some adjustments or non nested edge vms. But I didn’t want anything unexpected to happen to me during the deployment, so I decided to build the whole thing as close to reality as possible. My next attempt will be to build the setup as resource-efficient as possible.\nAs a nested ESX server, I used the Nested ESXi Virtual Appliance from William Lam and customized it for my use case. Each of the 8 ESXi virtual servers has 10 cores, 40GB of RAM and 3 hard disks. 16GB for the OS, 40 GB as an OSA cache tier and 400 GB as an OSA capacity tier. I use 2 network cards.\nThe virtual ESX servers run on 4 Minisforum MS-01 with 2x10 Gb network and 96 GB Ram each. I have 2 virtual servers running on each MS-01. The VMs run on local NVMe storage so that they are not unnecessarily moved via DRS. I have a nested ESXi server of AZ 1 and AZ 2 running on an MS-01. The vSAN Witness Appliance runs on my management ESX server.\nLab usage (click to enlarge)\nAfter the lab has booted and all services are running as they should, the resource requirements calm down a bit. I still have 200GB of RAM free on my physical hosts, so there is room for expansion and further tests.\nConclusion Deploying a stretched cluster is not that difficult if you follow all the preparations and meet all the requirements. The real challenge lies elsewhere, namely in the design of the actual stretched cluster.\n",
    "wordCount" : "2183",
    "inLanguage": "en",
    "image":"https://sdn-warrior.org/images/head.jpg","datePublished": "2025-03-13T23:00:00+01:00",
    "dateModified": "2025-03-13T23:00:00+01:00",
    "author":{
        "@type": "Person",
        "name": "SDN-Warrior",
        "url": "https://sdn-warrior.org/about/"
        },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://sdn-warrior.org/posts/vcf-stretched-cluster/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "SDN-Warrior | Daniel Krieger",
      "description": "",
      "logo": {
        "@type": "ImageObject",
        "url": "https://sdn-warrior.org/favicon.ico"
      }
    }
}
</script><title>VCF Stretched Cluster</title>
<link rel="stylesheet dns-prefetch preconnect preload prefetch" as="style" href="https://sdn-warrior.org/css/style.min.eb98efc18cb9c6a86651dce801c60b6d61ad5a37f7a6c35512028a9050e32033.css" integrity="sha256-65jvwYy5xqhmUdzoAcYLbWGtWjf3psNVEgKKkFDjIDM=" crossorigin="anonymous">
	<style>.bg-img {background-image: url('/images/head.jpg');}</style></head>
<body id="page">
	<header id="site-header">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://sdn-warrior.org/">SDN-Warrior | Daniel Krieger</a>
				</div>
				<nav class="site-nav hide-in-mobile"><a href="https://sdn-warrior.org/posts/">Posts</a><a href="https://sdn-warrior.org/lab-bom/">Lab BOM</a><a href="https://sdn-warrior.org/links/">Links</a><a href="https://sdn-warrior.org/about/">About Me</a></nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="img-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      <circle cx="8.5" cy="8.5" r="1.5"></circle>
      <polyline points="21 15 16 10 5 21"></polyline>
   </svg></button><span class="hdr-links hide-in-mobile"><a href="https://de.linkedin.com/in/daniel-krieger-6476591a9" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a></span><button id="share-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2">
      <circle cx="18" cy="5" r="3"></circle>
      <circle cx="6" cy="12" r="3"></circle>
      <circle cx="18" cy="19" r="3"></circle>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
   </svg></button>
 
<div id="share-links" class="animated fast">
    
    
    
    
    <ul>
        <li>
            <a href="https://twitter.com/intent/tweet?hashtags=hermit2&amp;url=https%3a%2f%2fsdn-warrior.org%2fposts%2fvcf-stretched-cluster%2f&amp;text=VCF%20Stretched%20Cluster" target="_blank" rel="noopener" aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path class="st0" d="m21.3 21.1 -11.4 -18.2h-7.2l11.4 18.2zm-18.6 0 7.2 -6.6m4.2 -5 7.2 -6.6" />
</svg></a>
        </li>
        <li>
            <a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsdn-warrior.org%2fposts%2fvcf-stretched-cluster%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg></a>
        </li>
        <li>
            <a href="mailto:?subject=VCF%20Stretched%20Cluster&amp;body=https%3a%2f%2fsdn-warrior.org%2fposts%2fvcf-stretched-cluster%2f" target="_self" rel="noopener" aria-label="Share on Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
   <polyline points="22,6 12,13 2,6"></polyline>
</svg></a>
        </li>
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsdn-warrior.org%2fposts%2fvcf-stretched-cluster%2f&amp;source=https%3a%2f%2fsdn-warrior.org%2f&amp;title=VCF%20Stretched%20Cluster&amp;summary=VCF%20Stretched%20Cluster%2c%20by%20SDN-Warrior%0a%0aA%20short%20article%20on%20how%20to%20build%20a%20stretched%20vSAN%20cluster%20in%20the%20VCF.%0a" target="_blank" rel="noopener" aria-label="Share on LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a>
        </li>
        <li>
            <a href="#" onclick="linkShare(&#34;VCF Stretched Cluster&#34;,&#34;https://sdn-warrior.org/posts/vcf-stretched-cluster/&#34;,&#34;VCF Stretched Cluster, by SDN-Warrior\n\nA short article on how to build a stretched vSAN cluster in the VCF.\n&#34;); return false;" target="_self" rel="noopener" aria-label="Copy Link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
   </svg></a>
        </li>
    </ul>
</div><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
   </svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://sdn-warrior.org/posts/">Posts</a></li>
			<li><a href="https://sdn-warrior.org/lab-bom/">Lab BOM</a></li>
			<li><a href="https://sdn-warrior.org/links/">Links</a></li>
			<li><a href="https://sdn-warrior.org/about/">About Me</a></li>
		</ul>
	</div>


	<div class="bg-img"></div>
	<main class="site-main section-inner animated fadeIn faster"><article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Mar 13, 2025</span></div>
				<h1>VCF Stretched Cluster</h1>
			</header>
			<div class="post-info"><p>A short article on how to build a stretched vSAN cluster in the VCF.</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
   stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather">
   <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
   <line x1="16" y1="8" x2="2" y2="22"></line>
   <line x1="17.5" y1="15" x2="9" y2="15"></line>
</svg><a href="/about/" target="_blank">SDN-Warrior</a></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon">
      <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
      <line x1="7" y1="7" x2="7" y2="7"></line>
   </svg><span class="tag"><a href="https://sdn-warrior.org/tags/vmware">vmware</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/vcf">vcf</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/homelab">homelab</a></span><span class="tag"><a href="https://sdn-warrior.org/tags/broadcom">broadcom</a></span></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
      <polyline points="10 9 9 9 8 9"></polyline>
   </svg>2183 Words
     Words // ReadTime
    
    
    
    9 Minutes, 55 Seconds</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
   </svg>2025-03-13 23:00 &#43;0100</p></div>
			<hr class="post-end">
			<div class="content">
				<h2 id="introduction">Introduction<a href="#introduction" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>This is my third article in my VCF Homelab series.
On second thought, I may have put the cart before the horse, because a stretched vSAN cluster requires a functioning management domain.
But ok, that shouldn&rsquo;t bother us now. I&rsquo;ll try to cover all the essentials of the deployment in this article.</p>
<h3 id="what-are-the-benefits-of-a-stretched-vsan-cluster-and-why-does-it-have-to-be-vsan">What are the benefits of a stretched vSAN cluster and why does it have to be vSAN?<a href="#what-are-the-benefits-of-a-stretched-vsan-cluster-and-why-does-it-have-to-be-vsan" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Well, first the obvious.
We have to use vSAN because we have a consolidated design here and VCF (version 5.2.1) does not allow any other principal storage in the consolidated design (also, this article is about a vSAN stretched cluster).
Secondly, we want to use the synchronous replication of vSAN to the second site. Another reason is “German Angst”. We want to have redundancy here and a muti AZ design. In Germany, there have traditionally been stretched clusters across multiple fire compartments or buildings for a long time. In the past, I myself have already implemented such scenarios with layer 2 over layer 3 (aka VxLAN).
The much more elegant way (and also the way supported by VCF) is the vSAN stretched cluster.</p>
<h2 id="lets-get-started">Let&rsquo;s get started<a href="#lets-get-started" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Of course, as always, there is a flip side to the coin. We can&rsquo;t just stretch a workload domain and all is well.
This is certainly not possible via the GUI of the SDDC Manager.
Yes, that&rsquo;s right, we will work with the API. But more on that later.
If we think about using one or more stretched workload domains, this always means that we also have to stretch our management domain.
This gives us the following requirements:</p>
<ul>
<li>8 ESXi servers for our Management Domain (4 per AZ)</li>
<li>Minimum 6 ESXi servers for Workload Domain (8 recommanded minimum)</li>
<li>Both availability zones must contain an equal number of hosts to ensure failover in case any of the availability zones goes down.</li>
<li>Redundant L3 gateways</li>
<li>A set of VLANs</li>
<li>A vSAN Witness Host (ESA or OSA Wthness Appliance)</li>
</ul>
<p>You cannot stretch a cluster in the following conditions:</p>
<ul>
<li>The cluster is a vSAN Max cluster.</li>
<li>The cluster has a vSAN remote datastore mounted on it.</li>
<li>The cluster shares a vSAN Storage Policy with any other clusters.</li>
<li>The cluster includes DPU-backed hosts.</li>
</ul>
<p>Latency vSphere</p>
<ul>
<li>Less than 150 ms latency RTT for vCenter Server connectivity.</li>
<li>Less than 150 ms latency RTT for vMotion connectivity.</li>
<li>Less than 5 ms latency RTT for VSAN hosts connectivity.</li>
</ul>
<p>Latency vSAN Site to Witness</p>
<ul>
<li>Less than 200 ms latency RTT for up to 10 hosts per site.</li>
<li>Less than 100 ms latency RTT for 11-15 hosts per site.</li>
</ul>
<p>Latency NSX Managers</p>
<ul>
<li>Less than 10 ms latency RTT between NSX Managers</li>
<li>Less than 150 ms latency RTT between NSX Managers and transport nodes.</li>
</ul>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Info</b>
        </div>
        <div class="admonition-content">I will only explain the stretching of the management domain in my article, as my resources in the lab are not infinite and the process is identical for the workload domain.</div>
    </aside>
<h2 id="vlans">VLANs<a href="#vlans" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<table>
  <thead>
      <tr>
          <th>Function</th>
          <th style="text-align: center">Availability Zone 1</th>
          <th style="text-align: center">Availability Zone 2</th>
          <th style="text-align: center">HA Layer 3 Gateway</th>
          <th style="text-align: center">Recommended MTU</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>VM Management VLAN</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">1500</td>
      </tr>
      <tr>
          <td>Management VLAN (AZ1)</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">1500</td>
      </tr>
      <tr>
          <td>vMotion VLAN</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">9000</td>
      </tr>
      <tr>
          <td>vSAN VLAN (AZ1)</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">9000</td>
      </tr>
      <tr>
          <td>NSX Host Overlay VLAN</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">9000</td>
      </tr>
      <tr>
          <td>NSX Edge Uplink01 VLAN</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">9000</td>
      </tr>
      <tr>
          <td>NSX Edge Uplink02 VLAN</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">9000</td>
      </tr>
      <tr>
          <td>NSX Edge Overlay VLAN</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">9000</td>
      </tr>
      <tr>
          <td>Management VLAN (AZ2)</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">1500</td>
      </tr>
      <tr>
          <td>vMotion VLAN (AZ2)</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">9000</td>
      </tr>
      <tr>
          <td>vSAN VLAN (AZ2)</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">9000</td>
      </tr>
      <tr>
          <td>NSX Host Overlay VLAN (AZ2)</td>
          <td style="text-align: center">X</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">✓</td>
          <td style="text-align: center">9000</td>
      </tr>
  </tbody>
</table>
<p>In your Lab setup you can also use 1700 byte MTU instead of 9000 byte mtu.
Redundant gateways are heavily dependent on the physical network design.
For a spine/leaf network with top of rack switches, you can use VRRP, HSRP or anycast gateway technology, depending on the manufacturer, expected traffic, fabric design and so on.
It depends heavily on the underlay design which is the right one here. In my setup, I have implemented the gateways on my top of rack switch.</p>
<h2 id="deploy-vsan-witness-host">Deploy vSAN Witness Host<a href="#deploy-vsan-witness-host" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>A vSAN Witness Host is required for a Stretched vSAN Cluster. Ready-made appliances can be downloaded from the Broadcom support portal. These are delivered as OVA and must be deployed on a third independent site. vSAN Witness can be connected either Layer 2 or Layer 3.</p>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Best Practice</b>
        </div>
        <div class="admonition-content">The recommended way would be a layer 3 connection and each site has an independent routed connection to the Witness Appliance.</div>
    </aside>
<p>After the successful deployment, the witness host must be registered in the vCenter of the management domain. You must add the vSAN witness host to the datacenter. Do not add it to a folder. Use the fully qualified domain name (FQDN) of the vSAN witness host, not the IP address.
There are a few adjustments to be made to the witness host:</p>
<ul>
<li>Remove the dedicated VMkernel adapter for witness traffic on the vSAN witness host.</li>
<li>Remove the network port group from the virtual machine on the vSAN witness host.</li>
<li>Enable witness traffic on the VMkernel adapter for the management network of the vSAN witness host.</li>
</ul>
<p>A step-by-step guide can be found in the <a href="https://techdocs.broadcom.com/us/en/vmware-cis/vcf/vcf-5-2-and-earlier/5-2/map-for-administering-vcf-5-2/stretching-clusters-admin/deploy-vsan-witness-host-admin/configure-the-vmkernel-adapters-on-the-vsan-witness-host-admin.html">VCF 5.2 Administration Guide</a>.</p>
<h2 id="commission-host">Commission Host<a href="#commission-host" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>As I already wrote in the intro, I assume for the article that a management domain is already deployed, but that it is not yet a stretched cluster.
The physical network is configured and all VLANs and IP networks are available.
Another network pool is also required. The vSAN and vMotion network is defined in this network pool.</p>

<figure><a href="02.png"><picture>
          <source srcset="/vcf-stretch/02_hu_34d1bd188ab32ee0.webp" type="image/webp">
          <source srcset="/vcf-stretch/02_hu_51c3bb0c9760a729.jpg" type="image/jpeg">
          <img src="/vcf-stretch/02_hu_34d1bd188ab32ee0.webp"alt="Network Pool"  width="1251"  height="875" />
        </picture></a><figcaption>
            <p>Network Pool (click to enlarge)</p>
          </figcaption></figure>
<p>Now that the preparations are complete, I can add the additional hosts in the sddc manager.
These must have the same build as the existing hosts in the cluster.
If, for example, the MGMT domain has been patched with ESXi patches to a different build than is in the BoM of VCF 5.2.1, then the additional hosts must be updated to the same version before they are provisioned.</p>

<figure><a href="01.png"><picture>
          <source srcset="/vcf-stretch/01_hu_f947f535f2a482d.webp" type="image/webp">
          <source srcset="/vcf-stretch/01_hu_41fca5e398d04962.jpg" type="image/jpeg">
          <img src="/vcf-stretch/01_hu_f947f535f2a482d.webp"alt="SDDC Manager"  width="1496"  height="891" />
        </picture></a><figcaption>
            <p>SDDC Manager (click to enlarge)</p>
          </figcaption></figure>
<p>After the hosts have been successfully commissioned in the SDDC manager, its not allowed to add them to the existing management domain.
Next, the cluster stretch spec must be created – this is the fun part of the deployment.</p>
<h2 id="stretch-a-vsan-cluster-aka-fun-part">Stretch a vSAN Cluster (aka Fun Part)<a href="#stretch-a-vsan-cluster-aka-fun-part" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Unfortunately, the actual stretch of the cluster cannot be conveniently carried out in the SDDC GUI. A JSON cluster stretch spec must be created and then passed to the SDDC manager via an API call.</p>

    <aside class="admonition attention">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24"
      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
   </svg></div><b>Attention</b>
        </div>
        <div class="admonition-content">The ESXi hosts that you are adding to availability zone 2 must use the same vmnic to vSphere Distributed Switch mapping as the existing hosts in availability zone 1.</div>
    </aside>
<p>The ESXi host ID is required for the JSON. This can be read out via an API call. The easiest way to do this is to use the Developer Center in the SDDC. Of course, any API tool will also work. At this point, I was just too lazy to generate an API token and did all the queries in the developer center of the SDDC manager.</p>

<figure><a href="03.png"><picture>
          <source srcset="/vcf-stretch/03_hu_21339beb0040c761.webp" type="image/webp">
          <source srcset="/vcf-stretch/03_hu_d595aa0f2442f59e.jpg" type="image/jpeg">
          <img src="/vcf-stretch/03_hu_21339beb0040c761.webp"alt="Developer Center"  width="1112"  height="798" />
        </picture></a><figcaption>
            <p>Developer Center (click to enlarge)</p>
          </figcaption></figure>
<p>The answer contains the IDs of the ESX servers, which can be easily transferred to the Cluster Stretch Spec. My Cluster Stretch Spec looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;clusterStretchSpec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;hostSpecs&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;vcf02-m01-esx05.lab.home&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hostNetworkSpec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;networkProfileName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-w01-az2-nsx-np01&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;vmNics&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;vmnic0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplink&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;vmnic1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplink&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;2bb45762-b2b9-4d94-8003-980f32d449f2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;licenseKey&#34;</span><span class="p">:</span> <span class="s2">&#34;XXXX-XXXXX-XXXXX-XXXXX-XXXXX&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;vcf02-m01-esx06.lab.home&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hostNetworkSpec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;networkProfileName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-w01-az2-nsx-np01&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;vmNics&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;vmnic0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplink&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;vmnic1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplink&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;a1fafaf3-bb88-4ee6-9a1b-a7ca0e8e9c47&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;licenseKey&#34;</span><span class="p">:</span> <span class="s2">&#34;XXXX-XXXXX-XXXXX-XXXXX-XXXXX&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;vcf02-m01-esx07.lab.home&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hostNetworkSpec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;networkProfileName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-w01-az2-nsx-np01&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;vmNics&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;vmnic0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplink&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;vmnic1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplink&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;a8ece8a4-9264-4b05-8637-02cbc0a85f45&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;licenseKey&#34;</span><span class="p">:</span> <span class="s2">&#34;XXXX-XXXXX-XXXXX-XXXXX-XXXXX&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;vcf02-m01-esx08.lab.home&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hostNetworkSpec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;networkProfileName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-w01-az2-nsx-np01&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;vmNics&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;vmnic0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplink&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;vmnic1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplink&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;c4e8e06f-5229-4d3c-86a3-a9f0f76fdea2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;licenseKey&#34;</span><span class="p">:</span> <span class="s2">&#34;XXXX-XXXXX-XXXXX-XXXXX-XXXXX&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;isEdgeClusterConfiguredForMultiAZ&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;networkSpec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;networkProfiles&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;isDefault&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-w01-az2-nsx-np01&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;nsxtHostSwitchConfigs&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;uplinkProfileName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-w01-az2-host-uplink-profile01&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsName&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-vds1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;vdsUplinkToNsxUplink&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;nsxUplinkName&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink-1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;vdsUplinkName&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;nsxUplinkName&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink-2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;vdsUplinkName&#34;</span><span class="p">:</span> <span class="s2">&#34;uplink2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;nsxClusterSpec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;uplinkProfiles&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-w01-az2-host-uplink-profile01&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;teamings&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;activeUplinks&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;uplink-1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;uplink-2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;DEFAULT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;policy&#34;</span><span class="p">:</span> <span class="s2">&#34;LOADBALANCE_SRCID&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;standByUplinks&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;transportVlan&#34;</span><span class="p">:</span> <span class="mi">1011</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;witnessSpec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;fqdn&#34;</span><span class="p">:</span> <span class="s2">&#34;vcf02-osa.lab.home&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;vsanCidr&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.12.0/24&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;vsanIp&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.12.22&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;witnessTrafficSharedWithVsanTraffic&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Next, the cluster stretch spec can be validated.The cluster ID is required for this.</p>
<p>This is also done as an API call. To do this, I go to the Developer Center, then to the managing clusters section, expand <em><strong>GET /v1/cluster</strong></em> end execute the API call.</p>
<p>Here is a small excerpt of what the response looks like. The correct ID is “id”: “e04c96fe-263c-4355-bdcf-7464b03e35d2”. The domain ID must not be used.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;elements&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;e04c96fe-263c-4355-bdcf-7464b03e35d2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;domain&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;40a61f61-0686-4514-b6a9-ba47c8533be9&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;sfo-m01-cluster-001&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;ACTIVE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;primaryDatastoreName&#34;</span><span class="p">:</span> <span class="s2">&#34;m01-cluster-001-vsan&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;primaryDatastoreType&#34;</span><span class="p">:</span> <span class="s2">&#34;VSAN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;hosts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;034f44ca-1654-450c-915f-6d3e072bee68&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;2bb45762-b2b9-4d94-8003-980f32d449f2&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;7cdd8928-575d-44b0-a604-834d3dd0bf13&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;9cbbe32f-31ce-450a-863c-31c39e248ab0&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span></code></pre></div><p>To perform the validate cluster stretch spec, I&rsquo;ll expand the “APIs for managing clusters” section and expand <em><strong>POST /v1/clusters/{id}/validations</strong></em>.
I enter the unique ID for the management cluster in the id text field.
In addition, the cluster stretch spec must be copied into the body field.</p>

<figure><a href="05.png"><picture>
          <source srcset="/vcf-stretch/05_hu_cc56115e897d13c2.webp" type="image/webp">
          <source srcset="/vcf-stretch/05_hu_6261fc54c387e02a.jpg" type="image/jpeg">
          <img src="/vcf-stretch/05_hu_cc56115e897d13c2.webp"alt="Validation"  width="1094"  height="867" />
        </picture></a><figcaption>
            <p>Cluster Stretch Spec Validation (click to enlarge)</p>
          </figcaption></figure>
<p>After the validation has been successfully completed, the cluster can be stretched.
To start the actual task, another API call must be made. This time <em><strong>PATCH /v1/clusters/{id}</strong></em>. The process is the same as for the validation. I copy the cluster ID into the ID field and copy the cluster stretch spec into the body field. After executing, the cluster stretch begins. This can be followed in the SDDC in the task bar.</p>

<figure><a href="04.png"><picture>
          <source srcset="/vcf-stretch/04_hu_45b1fe68b12725c2.webp" type="image/webp">
          <source srcset="/vcf-stretch/04_hu_ddba8f2fc28efcd0.jpg" type="image/jpeg">
          <img src="/vcf-stretch/04_hu_45b1fe68b12725c2.webp"alt="Cluster Stretch"  width="1720"  height="1200" />
        </picture></a><figcaption>
            <p>Cluster Stretch (click to enlarge)</p>
          </figcaption></figure>
<p>Depending on the performance of the environment, the process may take some time. For me, it was comparable to the duration of the bring-on of the unstretched management domain. If the task has been completed successfully, the SDDC and the vCenter should look like the following screenshots.</p>
<p>
<figure><a href="06.png"><picture>
          <source srcset="/vcf-stretch/06_hu_dd40b1da7bcc41bf.webp" type="image/webp">
          <source srcset="/vcf-stretch/06_hu_f20587ac75b8d2f9.jpg" type="image/jpeg">
          <img src="/vcf-stretch/06_hu_dd40b1da7bcc41bf.webp"alt="Stretched Cluster SDDC"  width="1487"  height="683" />
        </picture></a><figcaption>
            <p>Stretched Cluster SDDC (click to enlarge)</p>
          </figcaption></figure>

<figure><a href="07.png"><picture>
          <source srcset="/vcf-stretch/07_hu_4634a0f7f8e07457.webp" type="image/webp">
          <source srcset="/vcf-stretch/07_hu_53d1f9607b3016f7.jpg" type="image/jpeg">
          <img src="/vcf-stretch/07_hu_4634a0f7f8e07457.webp"alt="Stretched Cluster vCenter"  width="1716"  height="1084" />
        </picture></a><figcaption>
            <p>Stretched Cluster vCenter (click to enlarge)</p>
          </figcaption></figure></p>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Storage Policy</b>
        </div>
        <div class="admonition-content">When you stretch a cluster, VMware Cloud Foundation modifies the site disaster tolerance setting for storage policy associated with datastore of that cluster from None - standard cluster to Site mirroring - stretched cluster. This affects all VMs using default datastore policy in that cluster.</div>
    </aside>
<h2 id="notes">Notes<a href="#notes" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Further stretched cluster operations can be carried out via API.
A cluster expand or a cluster unstretch must currently still be carried out via API.
You also need to think about BGP peering. Depending on the setup, each side has its own AS number for BGP and Broadcom recommends working with route maps and local preference to control traffic.
Personally, I would say: it depends. However, this topic is so extensive that it may get its own blog article at some point.
In addition, you have to worry about the placement of VMs, storage policies and much more&hellip;</p>

    <aside class="admonition info">
        <div class="admonition-title">
            <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
   </svg></div><b>Opinion</b>
        </div>
        <div class="admonition-content">Design is always a matter of opinions and there is usually not just one perfect solution.</div>
    </aside>
<h2 id="lab-hardware-and-sizing-of-the-vms">Lab Hardware and Sizing of the VMs<a href="#lab-hardware-and-sizing-of-the-vms" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Perhaps a brief word about the resources used. I could have set up the lab more economically.
There is potential for savings in the NSX managers, where only one manager would have been needed with some adjustments or non nested edge vms.
But I didn&rsquo;t want anything unexpected to happen to me during the deployment, so I decided to build the whole thing as close to reality as possible.
My next attempt will be to build the setup as resource-efficient as possible.</p>
<p>As a nested ESX server, I used the <a href="https://williamlam.com/nested-virtualization/nested-esxi-virtual-appliance">Nested ESXi Virtual Appliance from William Lam</a> and customized it for my use case.
Each of the 8 ESXi virtual servers has 10 cores, 40GB of RAM and 3 hard disks. 16GB for the OS, 40 GB as an OSA cache tier and 400 GB as an OSA capacity tier. I use 2 network cards.</p>
<p>The virtual ESX servers run on 4 Minisforum MS-01 with 2x10 Gb network and 96 GB Ram each. I have 2 virtual servers running on each MS-01. The VMs run on local NVMe storage so that they are not unnecessarily moved via DRS.
I have a nested ESXi server of AZ 1 and AZ 2 running on an MS-01. The vSAN Witness Appliance runs on my management ESX server.</p>

<figure><a href="08.png"><picture>
          <source srcset="/vcf-stretch/08_hu_7143d1799f3f1a31.webp" type="image/webp">
          <source srcset="/vcf-stretch/08_hu_cb7c528aee9608e6.jpg" type="image/jpeg">
          <img src="/vcf-stretch/08_hu_7143d1799f3f1a31.webp"alt="Lab Usage"  width="552"  height="373" />
        </picture></a><figcaption>
            <p>Lab usage (click to enlarge)</p>
          </figcaption></figure>
<p>After the lab has booted and all services are running as they should, the resource requirements calm down a bit. I still have 200GB of RAM free on my physical hosts, so there is room for expansion and further tests.</p>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Deploying a stretched cluster is not that difficult if you follow all the preparations and meet all the requirements. The real challenge lies elsewhere, namely in the design of the actual stretched cluster.</p>

			</div>
			

<div class="related-posts thin">
	<h2>See Also</h2>
	<ul>
	
	<li><a href="/posts/vcf-import-overlay/">VCF Import Tool - Enable Overlay in an imported VCF Domain</a></li>
	
	<li><a href="/posts/vcf-import-cluster/">VCF Import Tool - Run VCF with NFS as principal Storage </a></li>
	
	<li><a href="/posts/homelab-v5/">Homelab V5</a></li>
	
	<li><a href="/posts/mac-learning/">MAC Learning is your friend</a></li>
	
	<li><a href="/posts/migration-with-hcx/">Migration with HCX</a></li>
	
	</ul>
</div>

		</article>
		<div class="post-nav thin">
			<a class="prev-post" href="https://sdn-warrior.org/posts/vcf-import-overlay/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right">
      <line x1="5" y1="12" x2="19" y2="12"></line>
      <polyline points="12 5 19 12 12 19"></polyline>
   </svg></span><br><span>VCF Import Tool - Enable Overlay in an imported VCF Domain</span>
			</a>
		</div>
		<div id="comments" class="thin"></div>
	</main>

<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>
		&copy; 2025 <a href="https://sdn-warrior.org/">SDN-Warrior</a>
		&#183; COPYRIGHT Daniel Krieger</p>

<script defer src="/klaro/klaro-config.js"></script>

<script defer src="/klaro/klaro.js"></script>
</footer>
<script async src="https://sdn-warrior.org/js/bundle.min.c7c384e4d29d192bbac6811ae4660bb01767194a5bea56baca77e8260f93ea16.js" integrity="sha256-x8OE5NKdGSu6xoEa5GYLsBdnGUpb6la6ynfoJg+T6hY=" crossorigin="anonymous"></script><script async src="https://sdn-warrior.org/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js" integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin="anonymous"></script>
</body>

</html>
